<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lector de Pasajes</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./NA28/out/na28-es.css?v=1">

  <style>
    
    :root{ --bd:#e6e8eb; --muted:#6b7280; }
    body{ background:#f8fafc; }
    .topbar{
      background:#ffffff;
      border-bottom:1px solid var(--bd);
      position:sticky; top:0; z-index:1000;
    }
    .sitewrap{ max-width: 1200px; }
    .panel{
      background:#fff;
      border:1px solid var(--bd);
      border-radius:12px;
    }
    .panel-header{
      border-bottom:1px solid var(--bd);
      padding:.75rem 1rem;
      font-weight:600;
    }
    .panel-body{ padding:1rem; }
    .meta-row{ color:var(--muted); font-size:.9rem; }
    .passage-title{ font-size:1.25rem; font-weight:700; }
    .passage-text{ font-size:1.05rem; line-height:1.85; }
    .orig-text{ font-size:1.05rem; line-height:1.85; }
    .verse-num{ color:#2563eb; font-weight:700; margin-right:.25rem; font-size:.85em; }
    .btn-soft{ background:#f1f5f9; border:1px solid var(--bd); }
    .btn-soft:hover{ background:#e9eef5; }
    .sticky-aside{ position: sticky; top: 86px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    /* Layout paralelo (español izquierda / original derecha) con colapsado del original */
    .parallel{ display:flex; flex-wrap:wrap; gap:1rem; }
    .parallel-col{ flex:1 1 360px; min-width:320px; }
    .orig-hidden #origCol{ display:none !important; }
    .orig-hidden #spanishCol{ flex:1 1 100%; min-width:100%; }

    /* Columna de herramientas a la izquierda, más compacta */
    .tools-panel .panel-body{ padding:.75rem; }
    .tools-panel .btn{ padding:.4rem .6rem; font-size:.9rem; }

    /* Greek font */
    .greek{
      font-family: 'Gentium Plus','SBL Greek','Times New Roman',serif;
      font-size: 1.1rem;
      line-height: 1.8;
    }

    .hebrew{
      direction: rtl;
      unicode-bidi: plaintext;
      font-family: 'SBL Hebrew','Ezra SIL','Times New Roman',serif;
      font-size: 1.12rem;
      line-height: 1.9;
    }

    /* Feedback animation */
    .feedback-badge{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.25rem .55rem;
      border-radius:999px;
      border:1px solid var(--bd);
      background:#f8fafc;
      font-size:.85rem;
      user-select:none;
      white-space:nowrap;
    }
    .feedback-badge.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .feedback-badge.err{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }

    .feedback-animate-pop{ animation: pop .18s ease-out; }
    .feedback-animate-shake{ animation: shake .28s ease-in-out; }

    .icon-check{
      width:14px;height:14px; display:inline-block;
      border-radius:50%;
      border:2px solid currentColor;
      position:relative;
    }
    .icon-check:after{
      content:"";
      position:absolute;
      left:3px; top:1px;
      width:4px; height:8px;
      border-right:2px solid currentColor;
      border-bottom:2px solid currentColor;
      transform:rotate(35deg);
    }

    .icon-x{
      width:14px;height:14px; display:inline-block;
      border-radius:50%;
      border:2px solid currentColor;
      position:relative;
    }
    .icon-x:before, .icon-x:after{
      content:"";
      position:absolute;
      left:5px; top:2px;
      width:2px; height:8px;
      background:currentColor;
      transform:rotate(45deg);
    }
    .icon-x:after{ transform:rotate(-45deg); }

    @keyframes pop{
      from{ transform:scale(.92); opacity:.6; }
      to{ transform:scale(1); opacity:1; }
    }
    @keyframes shake{
      0%{ transform:translateX(0); }
      25%{ transform:translateX(-3px); }
      50%{ transform:translateX(3px); }
      75%{ transform:translateX(-2px); }
      100%{ transform:translateX(0); }
    }

    .ctx-menu{
  position: fixed;
  z-index: 99999;
  background: #fff;
  border: 1px solid #e6e8eb;
  border-radius: 12px;
  box-shadow: 0 12px 30px rgba(0,0,0,.12);
  padding: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  user-select: none;
}

.ctx-dot{
  width: 22px; height: 22px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.08);
  cursor: pointer;
}

.ctx-sep{
  width:1px; height: 22px;
  background:#e6e8eb;
  margin: 0 2px;
}

.ctx-btn{
  width: 30px; height: 30px;
  border-radius: 10px;
  border: 1px solid #e6e8eb;
  background: #f8fafc;
  display:flex; align-items:center; justify-content:center;
  cursor: pointer;
}
.ctx-btn:hover{ background:#eef2f7; }
.ctx-btn svg{ width: 16px; height: 16px; opacity:.85; }

    .notas-panel{
  border: 1px solid rgba(0,0,0,.15);
  border-radius: .5rem;
  padding: .5rem;
  background: #fff;
}

.notas-toolbar{
  margin-bottom: .5rem;
}

.notas-list{
  max-height: 260px;      /* ajusta a tu diseño */
  overflow: auto;
}

.notas-item{
  display: flex;
  flex-direction: column;
  gap: .15rem;
}

.notas-item small{
  opacity: .75;
}
.notas-panel { padding: .4rem; }
.notas-toolbar { margin-bottom: .35rem; }

.notas-list{
  max-height: 320px;
  overflow: auto;
}

.notas-item{
  padding: .35rem .5rem !important;
  line-height: 1.15;
}

.notas-item > div{
  display: flex;
  gap: .35rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.notas-item strong{
  font-size: .85rem;
}

.note-firstword{
  font-size: .8rem;
  opacity: .7;
}

.notas-item small{
  display: none !important;
}
  </style>


<!-- ✅ ANTES del script grande: DB + UI (notas + highlights) -->
<script defer src="./annotations-db.js?v=2"></script>
<script defer src="./annotations-ui.js?v=4"></script>
<script defer src="./listanotas.js?v=1"></script>
  <script src="./greek-lexicon-ui.js"></script>
<script src="./diccionario/greek-lexicon.js?v=12"></script>


<script>
  window.addEventListener('DOMContentLoaded', () => {
    if (window.GreekLexicon?.init) window.GreekLexicon.init();
  });
</script>





</head>


<body>
  <!-- TOP SEARCH BAR -->
  <header class="topbar">
    <div class="container sitewrap py-2">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 gap-lg-3">
        <div class="d-flex align-items-center gap-2 flex-grow-1">
          <span class="badge text-bg-dark rounded-pill">Lector</span>
          <form id="searchForm" class="d-flex gap-2 flex-grow-1">
            <input id="searchInput" class="form-control" value="1 Corintios 13:1-7" placeholder="Buscar: ej. 1 Corintios 13 / 1Co 13:1-7"/>
            <select id="versionSelect" class="form-select" style="max-width:180px">
              <option value="RVR1960" selected>RVR1960</option>
            </select>
            <button class="btn btn-primary" type="submit">Buscar</button>
          </form>
        </div>

        <div class="d-flex gap-2">
          <button id="btnCopyLink" class="btn btn-soft btn-sm" type="button">Compartir</button>
          <button id="btnCopyText" class="btn btn-soft btn-sm" type="button">Copiar</button>
          <button id="btnPrint" class="btn btn-soft btn-sm" type="button">Imprimir</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container sitewrap my-3 my-lg-4">
    <!-- Header: título + versión (sin navegación) -->
    <div class="d-flex flex-column gap-2 mb-3">
      <div class="d-flex flex-column flex-md-row justify-content-between gap-2 align-items-md-start">
        <div>
          <div class="passage-title" id="pageTitle">—</div>
          <div class="meta-row">
            Versión: <span class="fw-semibold" id="metaVersion">—</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- LEFT TOOLS (compact) -->
      <aside class="col-12 col-lg-2">
        <div class="sticky-aside d-flex flex-column gap-3">
          <section class="panel tools-panel">
            <div class="panel-header">Herramientas</div>
            <div class="panel-body d-grid gap-2">
              <button class="btn btn-soft w-100" type="button" disabled>Comparar</button>
            <button id="btnNotas" type="button" class="btn btn-outline-primary">
    Notas
  </button>
              <!-- Panel desplegable (queda exactamente debajo del botón) -->
  <div id="notasPanel" class="notas-panel d-none">
    <div class="notas-toolbar">
      <input id="notasSearch" class="form-control form-control-sm" placeholder="Buscar cita o palabra...">
    </div>
    <div id="notasList" class="list-group notas-list"></div>
  </div>

              <button class="btn btn-soft w-100" type="button" id="btnNA28Es">
  Edition NA28-Es
</button>

            </div>
          </section>

          <section class="panel">
            <div class="panel-header">Ayuda</div>
            <div class="panel-body text-muted" style="font-size:.9rem">
              Ejemplos: <span class="mono">1Cor 3</span>, <span class="mono">1 Cor 13:1-7</span>, <span class="mono">1 Corintios 15:58</span>
            </div>
          </section>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="col-12 col-lg-10">
        <section class="panel">
          <div class="panel-header d-flex justify-content-between align-items-center gap-2">
            <span>Texto del pasaje</span>

            <div class="d-flex align-items-center gap-2">
              <span class="text-muted" style="font-weight:400; font-size:.9rem" id="statusLine"></span>
              <span id="feedbackBadge" class="feedback-badge" style="display:none"></span>
              <button id="btnToggleOrig" class="btn btn-soft btn-sm" type="button" aria-expanded="true">
                Ocultar original
              </button>
            </div>
          </div>

<div class="panel-body">

  <!-- ===== TEXTO BÍBLICO NORMAL (RVR + ORIGINAL) ===== -->
  <div id="biblePanel">
    <div class="parallel">
      <!-- IZQUIERDA: Español -->
      <div id="spanishCol" class="parallel-col">
        <div class="fw-semibold mb-2" id="leftLabel">RVR1960</div>
        <div class="passage-text" id="passageTextRV">
          <div class="text-muted">Cargando datos…</div>
        </div>
      </div>

      <!-- DERECHA: Original -->
      <div id="origCol" class="parallel-col">
        <div class="fw-semibold mb-2" id="rightLabel">Original</div>
        <div class="orig-text" id="passageTextOrig">
          <div class="text-muted">Cargando datos…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== PANEL NA28-ES (OCULTO POR DEFECTO) ===== -->
  <div id="na28Panel" class="d-none mt-3">

    <!-- Selectores -->
    <div class="row g-2 mb-2">
      <div class="col-12 col-md-4">
        <select id="na28Book" class="form-select form-select-sm"></select>
      </div>
      <div class="col-6 col-md-4">
        <select id="na28Chapter" class="form-select form-select-sm"></select>
      </div>
      <div class="col-6 col-md-4">
        <select id="na28Verse" class="form-select form-select-sm"></select>
      </div>
    </div>

    <!-- Contenido NA28 -->
    <div id="na28Viewer"></div>

  </div>

</div>

        </section>

      </div>
    </div>
  </main>

  <script>
/***********************
 * Config
 ***********************/
const params = new URLSearchParams(window.location.search);

const RV_BASE = params.get('rvBase') || './librosRV1960/';
const GRIEGO_PATH = './IdiomaORIGEN/Bgriega.json';

// ✅ Hebreo por libro (con nikkud): IdiomaORIGEN/genesis.json, exodo.json, amos.json, etc.
const HEBREO_BOOK_BASE = params.get('heBase') || './IdiomaORIGEN/';

// Si quieres forzar ocultar original por defecto: ?orig=0
const ORIGINAL_ENABLED_DEFAULT = (params.get('orig') ?? '1') !== '0';

// Estado actual (se puede cambiar desde el buscador)
let currentBookSlug = (params.get('book') || '1_corintios').trim();
let currentBookName = (params.get('name') || prettyBookName(currentBookSlug));

/***********************
 * Canon + aliases (Genesis -> Apocalipsis)
 ***********************/
const NT_BOOKS = new Set([
  'mateo','marcos','lucas','juan','hechos',
  'romanos','1_corintios','2_corintios','galatas','efesios','filipenses','colosenses',
  '1_tesalonicenses','2_tesalonicenses','1_timoteo','2_timoteo','tito','filemon',
  'hebreos','santiago','1_pedro','2_pedro','1_juan','2_juan','3_juan','judas','apocalipsis'
]);
function isNT(slug){ return NT_BOOKS.has(slug); }

function normalizeKey(s){
  return (s || '')
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,'')
    .replace(/\./g,'')
    .replace(/\s+/g,'')
    .trim();
}
function prettyBookName(slug){
  return (slug || '').replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
}
function slugifyBookName(name){
  return (name || '')
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,'')
    .replace(/\./g,'')
    .trim()
    .replace(/\s+/g,' ')
    .replace(/^(\d)\s+/, '$1 ')
    .replace(/\s/g,'_');
}

// Aliases amplios (comunes). La clave es "normalizada" (sin espacios ni tildes)
const BOOK_ALIASES = {
  // Pentateuco
  'genesis':'genesis','gen':'genesis','gn':'genesis',
  'exodo':'exodo','exo':'exodo','ex':'exodo',
  'levitico':'levitico','lev':'levitico','lv':'levitico',
  'numeros':'numeros','num':'numeros','nm':'numeros',
  'deuteronomio':'deuteronomio','deut':'deuteronomio','dt':'deuteronomio',

  // Históricos
  'josue':'josue','jos':'josue',
  'jueces':'jueces','jue':'jueces','jdg':'jueces',
  'rut':'rut','rt':'rut',
  '1samuel':'1_samuel','1sa':'1_samuel','1sam':'1_samuel',
  '2samuel':'2_samuel','2sa':'2_samuel','2sam':'2_samuel',
  '1reyes':'1_reyes','1rey':'1_reyes','1ki':'1_reyes','1kgs':'1_reyes',
  '2reyes':'2_reyes','2rey':'2_reyes','2ki':'2_reyes','2kgs':'2_reyes',
  '1cronicas':'1_cronicas','1cro':'1_cronicas','1cr':'1_cronicas',
  '2cronicas':'2_cronicas','2cro':'2_cronicas','2cr':'2_cronicas',
  'esdras':'esdras','esd':'esdras','ezra':'esdras',
  'nehemias':'nehemias','neh':'nehemias',
  'ester':'ester','est':'ester',

  // Poéticos
  'job':'job','jb':'job',
  'salmos':'salmos','salmo':'salmos','sal':'salmos','ps':'salmos',
  'proverbios':'proverbios','prov':'proverbios','pr':'proverbios',
  'eclesiastes':'eclesiastes','ecl':'eclesiastes','ec':'eclesiastes',
  'cantares':'cantares','cantar':'cantares','cnt':'cantares','cant':'cantares',

  // Profetas mayores
  'isaias':'isaias','isa':'isaias',
  'jeremias':'jeremias','jer':'jeremias',
  'lamentaciones':'lamentaciones','lam':'lamentaciones',
  'ezequiel':'ezequiel','eze':'ezequiel','ez':'ezequiel',
  'daniel':'daniel','dan':'daniel',

  // Profetas menores
  'oseas':'oseas','os':'oseas',
  'joel':'joel','jl':'joel',
  'amos':'amos','am':'amos',
  'abdias':'abdias','abd':'abdias','obadias':'abdias','obad':'abdias',
  'jonas':'jonas','jon':'jonas',
  'miqueas':'miqueas','miq':'miqueas','mic':'miqueas',
  'nahum':'nahum','nah':'nahum',
  'habacuc':'habacuc','hab':'habacuc',
  'sofonias':'sofonias','sof':'sofonias','zep':'sofonias',
  'hageo':'hageo','hag':'hageo',
  'zacarias':'zacarias','zac':'zacarias','zec':'zacarias',
  'malaquias':'malaquias','mal':'malaquias',

  // Evangelios / Hechos
  'mateo':'mateo','mt':'mateo',
  'marcos':'marcos','mr':'marcos','mk':'marcos',
  'lucas':'lucas','lc':'lucas','lk':'lucas',
  'juan':'juan','jn':'juan','jhn':'juan',
  'hechos':'hechos','hch':'hechos','actos':'hechos','act':'hechos',

  // Paulinas
  'romanos':'romanos','rom':'romanos',
  '1corintios':'1_corintios','1cor':'1_corintios','1co':'1_corintios',
  '2corintios':'2_corintios','2cor':'2_corintios','2co':'2_corintios',
  'galatas':'galatas','gal':'galatas',
  'efesios':'efesios','efe':'efesios','eph':'efesios',
  'filipenses':'filipenses','fil':'filipenses','php':'filipenses',
  'colosenses':'colosenses','col':'colosenses',
  '1tesalonicenses':'1_tesalonicenses','1tes':'1_tesalonicenses','1th':'1_tesalonicenses',
  '2tesalonicenses':'2_tesalonicenses','2tes':'2_tesalonicenses','2th':'2_tesalonicenses',
  '1timoteo':'1_timoteo','1tim':'1_timoteo',
  '2timoteo':'2_timoteo','2tim':'2_timoteo',
  'tito':'tito','tit':'tito',
  'filemon':'filemon','flm':'filemon','phm':'filemon',
  'hebreos':'hebreos','heb':'hebreos',

  // Generales + Apocalipsis
  'santiago':'santiago','stg':'santiago','jas':'santiago',
  '1pedro':'1_pedro','1pe':'1_pedro','1pet':'1_pedro',
  '2pedro':'2_pedro','2pe':'2_pedro','2pet':'2_pedro',
  '1juan':'1_juan','1jn':'1_juan','1j':'1_juan',
  '2juan':'2_juan','2jn':'2_juan','2j':'2_juan',
  '3juan':'3_juan','3jn':'3_juan','3j':'3_juan',
  'judas':'judas','jud':'judas',
  'apocalipsis':'apocalipsis','apo':'apocalipsis','apoc':'apocalipsis','rev':'apocalipsis'
};

function resolveBookSlug(bookRaw){
  const key = normalizeKey(bookRaw);
  if(BOOK_ALIASES[key]) return BOOK_ALIASES[key];

  // Manejo "1 cor" -> "1cor"
  const key2 = key.replace(/^([123])/, '$1');
  if(BOOK_ALIASES[key2]) return BOOK_ALIASES[key2];

  return slugifyBookName(bookRaw);
}

/***********************
 * Mapeos para Original (book_name dentro de los JSON grandes)
 ***********************/
const NT_TR_BOOKNAME = {
  mateo: 'Matthew', marcos: 'Mark', lucas: 'Luke', juan: 'John', hechos: 'Acts',
  romanos: 'Romans', '1_corintios': '1 Corinthians', '2_corintios': '2 Corinthians',
  galatas: 'Galatians', efesios: 'Ephesians', filipenses: 'Philippians', colosenses: 'Colossians',
  '1_tesalonicenses': '1 Thessalonians', '2_tesalonicenses': '2 Thessalonians',
  '1_timoteo': '1 Timothy', '2_timoteo': '2 Timothy', tito: 'Titus', filemon: 'Philemon',
  hebreos: 'Hebrews', santiago: 'James', '1_pedro': '1 Peter', '2_pedro': '2 Peter',
  '1_juan': '1 John', '2_juan': '2 John', '3_juan': '3 John', judas: 'Jude', apocalipsis: 'Revelation'
};

/***********************
 * DOM
 ***********************/
const form = document.getElementById('searchForm');
const searchInput = document.getElementById('searchInput');
const versionSelect = document.getElementById('versionSelect');
const metaVersion = document.getElementById('metaVersion');
const pageTitle = document.getElementById('pageTitle');
const statusLine = document.getElementById('statusLine');

const passageTextRV = document.getElementById('passageTextRV');
const passageTextOrig = document.getElementById('passageTextOrig');

const leftLabel = document.getElementById('leftLabel');
const rightLabel = document.getElementById('rightLabel');

const btnCopyLink = document.getElementById('btnCopyLink');
const btnCopyText = document.getElementById('btnCopyText');
const btnPrint = document.getElementById('btnPrint');
const btnToggleOrig = document.getElementById('btnToggleOrig');

/***********************
 * Data / caches
 ***********************/
let lastRef = null;
const rvCache = {};                 // slug -> chapters[][]
let trData = null;                  // NT griego completo (verses[])
const trChaptersCache = {};         // slug -> chapters[][]

// ✅ Hebreo por libro (cada archivo ya trae text[][])
const heBookCache = {};             // slug -> chapters[][]

let bookDataRV = null;
let bookDataOrig = null;

/***********************
 * Helpers
 ***********************/
function esc(s){
  return (s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#39;");
}
function fmtVerse(raw){
  // normaliza: "/n", "\\n" y saltos reales -> "\n"
  const normalized = String(raw ?? '').replace(/\/n|\\n/g, '\n');
  // escapa HTML y luego convierte saltos a <br>
  return esc(normalized).replace(/\n/g, '<br>');
}


function normalizeSpaces(s){
  return (s || '').trim().replace(/\s+/g,' ');
}
async function loadJson(path){
  const r = await fetch(path, { cache: 'no-store' });
  if(!r.ok) throw new Error(`No se pudo cargar ${path} (HTTP ${r.status})`);
  return await r.json();
}
function buildPermalink(search, version){
  const p = new URLSearchParams();
  p.set('book', currentBookSlug);
  p.set('name', currentBookName);
  p.set('search', search);
  p.set('version', version);
  p.set('orig', ORIGINAL_ENABLED_DEFAULT ? '1' : '0');
  return `${location.origin}${location.pathname}?${p.toString()}`;
}
async function copy(text){
  try{ await navigator.clipboard.writeText(text); }catch{}
}

/***********************
 * Builder: verses[] -> chapters[][]
 ***********************/
function buildChaptersFromVersesForBook(allVerses, bookName){
  if(!bookName || !Array.isArray(allVerses)) return null;

  const verses = allVerses.filter(v => v && v.book_name === bookName);

  let maxCh = 0;
  const maxVerseByCh = {};
  for(const v of verses){
    const ch = Number(v.chapter);
    const vs = Number(v.verse);
    if(Number.isFinite(ch) && ch > maxCh) maxCh = ch;
    if(!maxVerseByCh[ch] || vs > maxVerseByCh[ch]) maxVerseByCh[ch] = vs;
  }
  if(maxCh <= 0) return null;

  const chapters = Array.from({length: maxCh}, (_, i) => {
    const ch = i+1;
    const len = maxVerseByCh[ch] || 0;
    return Array.from({length: len}, () => '');
  });

  for(const v of verses){
    const ch = Number(v.chapter);
    const vs = Number(v.verse);
    if(ch >= 1 && ch <= chapters.length && vs >= 1 && vs <= chapters[ch-1].length){
      chapters[ch-1][vs-1] = v.text || '';
    }
  }
  return chapters;
}

/***********************
 * Cargar libro: Español + (opcional) Original
 ***********************/
async function ensureBookLoaded(slug, displayName){
  // Español (requerido)
  if(!rvCache[slug]){
    const path = `${RV_BASE}${slug}.json`;
    rvCache[slug] = await loadJson(path);
  }
  bookDataRV = rvCache[slug];

  // Original (opcional). Si falla, NO tumba el español.
  bookDataOrig = null;

  if(!ORIGINAL_ENABLED_DEFAULT){
    rightLabel.textContent = 'Original (off)';
    passageTextOrig.innerHTML = `<div class="text-muted">Original desactivado.</div>`;
    return;
  }

  if(isNT(slug)){
    rightLabel.textContent = 'Griego';
    passageTextOrig.classList.remove('hebrew');
    passageTextOrig.classList.add('greek');

    try{
      if(!trData) trData = await loadJson(GRIEGO_PATH);
      if(!trChaptersCache[slug]){
        const bookName = NT_TR_BOOKNAME[slug];
        trChaptersCache[slug] = buildChaptersFromVersesForBook(trData.verses, bookName);
      }
      bookDataOrig = trChaptersCache[slug] || null;

      if(!bookDataOrig){
        passageTextOrig.innerHTML = `<div class="text-muted">Griego no disponible para este libro (revisa mapeo).</div>`;
      }
    }catch(err){
      passageTextOrig.innerHTML = `<div class="text-muted">Griego no disponible: ${esc(err.message || String(err))}</div>`;
      bookDataOrig = null;
    }

  } else {
    // ✅ AT: Hebreo por libro: IdiomaORIGEN/<slug>.json, con raíz: { metadata, text: [[...],[...]] }
    rightLabel.textContent = 'Hebreo';
    passageTextOrig.classList.remove('greek');
    passageTextOrig.classList.add('hebrew');

    try{
      if(!heBookCache[slug]){
        const path = `${HEBREO_BOOK_BASE}${slug}.json`;
        const heBook = await loadJson(path);

        if(!heBook || !Array.isArray(heBook.text)){
          throw new Error(`Estructura hebrea inválida en ${path}: falta "text" como array (chapters[][]).`);
        }

        // Normaliza a strings (por si hay nulls)
        heBookCache[slug] = heBook.text.map(ch => Array.isArray(ch) ? ch.map(v => (v ?? '')) : []);
      }

      bookDataOrig = heBookCache[slug] || null;

      if(!bookDataOrig){
        passageTextOrig.innerHTML = `<div class="text-muted">Hebreo no disponible para este libro.</div>`;
      }
    }catch(err){
      passageTextOrig.innerHTML = `<div class="text-muted">Hebreo no disponible: ${esc(err.message || String(err))}</div>`;
      bookDataOrig = null;
    }
  }

  currentBookSlug = slug;
  currentBookName = displayName || prettyBookName(slug);
}

/***********************
 * Parse búsqueda
 ***********************/
function parseSearch(raw){
  const q = normalizeSpaces(raw);
  if(!q) return null;

  // ✅ Solo acepta búsquedas que incluyan libro
  const m = q.match(/^(.+?)\s+(\d+)(?::(\d+)(?:\s*-\s*(\d+))?)?\s*$/);
  if(!m) return null;

  const bookRaw = m[1];
  const slug = resolveBookSlug(bookRaw);
  const chapter = parseInt(m[2],10);
  const verseStart = m[3] ? parseInt(m[3],10) : null;
  const verseEnd = m[4] ? parseInt(m[4],10) : (verseStart ? verseStart : null);

  return { slug, bookDisplay: bookRaw, chapter, verseStart, verseEnd };
}

/***********************
 * Render
 ***********************/
function clearFeedback(){
  const b = document.getElementById('feedbackBadge');
  if(!b) return;
  b.style.display = 'none';
  b.className = 'feedback-badge';
  b.innerHTML = '';
}

function showFeedback(kind, text){
  const b = document.getElementById('feedbackBadge');
  if(!b) return;
  b.style.display = 'inline-flex';
  b.className = 'feedback-badge ' + (kind === 'ok' ? 'ok feedback-animate-pop' : 'err feedback-animate-shake');
  const icon = kind === 'ok' ? '<span class="icon-check" aria-hidden="true"></span>' : '<span class="icon-x" aria-hidden="true"></span>';
  b.innerHTML = icon + '<span>' + esc(text) + '</span>';
  setTimeout(() => b.classList.remove('feedback-animate-pop','feedback-animate-shake'), 350);
}

function render(ref){
  if(!bookDataRV) return;

  clearFeedback();

  const chapterCount = bookDataRV.length;

  // Validación: capítulo solicitado
  if(ref.chapter < 1 || ref.chapter > chapterCount){
    pageTitle.textContent = `${currentBookName} ${ref.chapter}`;
    metaVersion.textContent = versionSelect.value;
    statusLine.textContent = `Capítulos: ${chapterCount}`;
    passageTextRV.innerHTML = `<div class="text-muted">No existe el capítulo <strong>${esc(String(ref.chapter))}</strong> en <strong>${esc(currentBookName)}</strong>.</div>`;
    passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
    showFeedback('err', 'Verso / capítulo no encontrado');
    return;
  }

  const ch = ref.chapter;
  const versesRV = bookDataRV[ch-1] || [];
  const verseCount = versesRV.length;

  // Validación: versículo solicitado
  if(ref.verseStart != null){
    const v1req = ref.verseStart;
    const v2req = ref.verseEnd ?? v1req;
    if(v1req < 1 || v1req > verseCount || v2req < 1 || v2req > verseCount){
      pageTitle.textContent = `${currentBookName} ${ch}:${v1req}${(v2req!==v1req?'-'+v2req:'')}`;
      metaVersion.textContent = versionSelect.value;
      statusLine.textContent = `Capítulos: ${chapterCount} · Cap ${ch}: ${verseCount} vers.`;
      passageTextRV.innerHTML = `<div class="text-muted">No existe ese versículo en <strong>${esc(currentBookName)} ${ch}</strong>. Rango válido: 1–${verseCount}.</div>`;
      passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
      showFeedback('err', 'Verso / capítulo no encontrado');
      return;
    }
  }

  let v1 = ref.verseStart ?? 1;
  let v2 = ref.verseEnd ?? verseCount;
  if(v2 < v1) [v1, v2] = [v2, v1];

  lastRef = { chapter: ch, verseStart: v1, verseEnd: v2 };

  const range = (ref.verseStart == null)
    ? `${currentBookName} ${ch}`
    : `${currentBookName} ${ch}:${v1}${(v2 !== v1 ? '-' + v2 : '')}`;

  pageTitle.textContent = range;
  metaVersion.textContent = versionSelect.value;

  // Español
  let htmlRV = '';
  for(let v=v1; v<=v2; v++){
    const t = versesRV[v-1] ?? '';
 htmlRV += `<p class="mb-2 verse-line" data-side="rv" data-book="${esc(currentBookSlug)}" data-ch="${ch}" data-v="${v}">
    <span class="verse-num">${v}</span><span class="verse-text">${fmtVerse(t)}</span>
    </p>`;

  }
  passageTextRV.innerHTML = htmlRV || `<div class="text-muted">Sin contenido para esta referencia.</div>`;

  // Original
  if(bookDataOrig){
    const versesOrig = bookDataOrig[ch-1] || [];
    let htmlOrig = '';
    for(let v=v1; v<=v2; v++){
      const t = versesOrig[v-1] ?? '';
      htmlOrig += `<p class="mb-2 verse-line" data-side="orig" data-book="${esc(currentBookSlug)}" data-ch="${ch}" data-v="${v}">
        <span class="verse-num">${v}</span><span class="verse-text">${esc(t)}</span>
      </p>`;
    }
    passageTextOrig.innerHTML = htmlOrig || `<div class="text-muted">Sin contenido original para esta referencia.</div>`;
    // ✅ Hacer cada palabra griega clickeable (antes de subrayados/notas)
if (window.GreekLexicon?.decoratePassage) {
  window.GreekLexicon.decoratePassage(passageTextOrig, currentBookSlug, ch, v1, v2);
}

  } else {
    passageTextOrig.innerHTML = `<div class="text-muted">Original no disponible para esta referencia.</div>`;
  }

  statusLine.textContent = `Capítulos: ${chapterCount} · Cap ${ch}: ${verseCount} vers.`;
  showFeedback('ok', 'Cita encontrada');

  const userSearch = normalizeSpaces(searchInput.value) || range;
  history.replaceState(
    null,
    '',
    `?book=${encodeURIComponent(currentBookSlug)}&name=${encodeURIComponent(currentBookName)}&search=${encodeURIComponent(userSearch)}&version=${encodeURIComponent(versionSelect.value)}&orig=${ORIGINAL_ENABLED_DEFAULT?'1':'0'}`
  );


// ✅ Aplicar subrayados y notas guardadas (IndexedDB) después de renderizar el DOM
if (window.AnnotationsUI_applyHighlightsToPassage) {
  window.AnnotationsUI_applyHighlightsToPassage(currentBookSlug, ch, v1, v2);
}
if (window.AnnotationsUI_applyNotesToPassage) {
  window.AnnotationsUI_applyNotesToPassage(currentBookSlug, ch, v1, v2);
}
  // ✅ Comentarios bíblicos (solo si hay JSON para ese capítulo)
if (window.BibleComments?.attachCommentsToRV) {
  window.BibleComments.attachCommentsToRV(passageTextRV, currentBookSlug, ch);
}


}


async function runSearch(){
  const raw = normalizeSpaces(searchInput.value);
  if(!raw){
    passageTextRV.innerHTML = `<div class="text-muted">Escribe una referencia.</div>`;
    passageTextOrig.innerHTML = `<div class="text-muted">Escribe una referencia.</div>`;
    return;
  }

  const ref = parseSearch(raw);

  // ✅ Si NO es una referencia, se interpreta como búsqueda por palabra/frase
  if(!ref){
    const q = raw.trim();
    if(q){
      const p = new URLSearchParams();
      p.set('q', q);
      p.set('mode', 'all');     // all | es | gr | he (tu busqueda.html)
      p.set('exact', '0');      // 1 si quieres exacta por defecto
      // Puedes pasar también la versión si luego la usas en busqueda.html
      p.set('version', versionSelect.value || 'RVR1960');

    // ✅ Guardar estado del lector (para restaurar si el navegador recarga)
try{
  const state = {
    url: location.href,
    scrollY: window.scrollY || 0,
    origHidden: document.body.classList.contains('orig-hidden') ? 1 : 0,
    // opcional: lo que el usuario estaba viendo
    currentBookSlug: window.currentBookSlug || null,
    currentBookName: window.currentBookName || null,
    lastSearch: (document.getElementById('searchInput')?.value || '').trim()
  };
  sessionStorage.setItem('lectorState', JSON.stringify(state));
}catch{}

      window.location.href = `./busqueda.html?${p.toString()}`;
      return;
    }

    // Si está vacío, muestra mensaje
    const msg = `<div class="text-muted">Escribe una referencia o una palabra.</div>`;
    passageTextRV.innerHTML = msg;
    passageTextOrig.innerHTML = msg;
    return;
  }


  try{
    await ensureBookLoaded(ref.slug, ref.bookDisplay);
    leftLabel.textContent = versionSelect.value;
    render(ref);
  }catch(err){
    const msg = `<div class="text-danger fw-semibold">Error:</div><div class="text-muted">${esc(err.message || String(err))}</div>`;
    passageTextRV.innerHTML = msg;
    passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
    statusLine.textContent = '';
  }
}

/***********************
 * URL + UI
 ***********************/
function setFromUrl(){
  const p = new URLSearchParams(location.search);
  const q = p.get('search');
  const v = p.get('version');
  const bk = p.get('book');
  const nm = p.get('name');

  if(bk) currentBookSlug = bk.trim();
  if(nm) currentBookName = nm.trim();
  if(q) searchInput.value = q;
  if(v) versionSelect.value = v;
}

function setOriginalVisible(isVisible){
  document.body.classList.toggle('orig-hidden', !isVisible);
  btnToggleOrig.setAttribute('aria-expanded', String(isVisible));
  btnToggleOrig.textContent = isVisible ? 'Ocultar original' : 'Mostrar original';
}

/***********************
 * Events
 ***********************/
form.addEventListener('submit', (e) => { e.preventDefault(); runSearch(); });

btnCopyLink.addEventListener('click', async () => {
  const link = buildPermalink(searchInput.value || pageTitle.textContent, versionSelect.value);
  await copy(link);
});

btnCopyText.addEventListener('click', async () => {
  const left = (passageTextRV.innerText || '').trim();
  const right = (passageTextOrig.innerText || '').trim();
  const includeOrig = !document.body.classList.contains('orig-hidden');
  const combined =
    includeOrig
      ? `=== ${leftLabel.textContent} ===\n${left}\n\n=== ${rightLabel.textContent} ===\n${right}\n`
      : `=== ${leftLabel.textContent} ===\n${left}\n`;
  await copy(combined);
});

btnPrint.addEventListener('click', () => window.print());

btnToggleOrig.addEventListener('click', () => {
  const isVisible = !document.body.classList.contains('orig-hidden');
  setOriginalVisible(!isVisible);
});

/***********************
 * Boot
 ***********************/
(async function boot(){
  setFromUrl();
  setOriginalVisible(ORIGINAL_ENABLED_DEFAULT);

  leftLabel.textContent = versionSelect.value;
  metaVersion.textContent = versionSelect.value;

  try{
    passageTextRV.innerHTML = `<div class="text-muted">Cargando ${leftLabel.textContent}…</div>`;
    passageTextOrig.innerHTML = `<div class="text-muted">Cargando Original…</div>`;
    await ensureBookLoaded(currentBookSlug, currentBookName);
    await runSearch();

    // ✅ Restaurar scroll/estado si venimos de busqueda.html
try{
  const raw = sessionStorage.getItem('lectorState');
  if(raw){
    const st = JSON.parse(raw);

    // Restaura visibilidad original
    if(typeof st.origHidden === 'number'){
      setOriginalVisible(st.origHidden ? false : true);
    }

    // Restaura scroll
    if(typeof st.scrollY === 'number'){
      requestAnimationFrame(() => window.scrollTo(0, st.scrollY));
    }

    // Limpia para que no se re-aplique siempre
    sessionStorage.removeItem('lectorState');
  }
}catch{}

  }catch(err){
    const msg = `<div class="text-danger fw-semibold">Error:</div><div class="text-muted">${esc(err.message || String(err))}</div>`;
    passageTextRV.innerHTML = msg;
    passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
    statusLine.textContent = '';
  }
})();
  </script>

  <div id="ctxMenu" class="ctx-menu" style="display:none" aria-hidden="true"></div>
<script src="./comentarios/comentarios.js"></script>
  <script defer src="./na28-es-ui.js?v=1"></script>



</body>
</html>
