<!doctype html>
<html lang="es" data-theme="cream">
<head>
  <meta charset="utf-8"/>
 <meta name="viewport" content="width=1024, initial-scale=1"/>
  <title>Lector de Pasajes</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> 
  <link rel="stylesheet" href="./RKANT/out/rkant-es.css?v=1">
   <link rel="stylesheet" href="./backup-panel.css?v=1">

  <style>
    
   :root{
      --bd:#e6e8eb;
      --muted:#6b7280;
      --bg:#f8fafc;
      --surface:#ffffff;
      --text:#0f172a;
      --primary:#2563eb;
      --primary-contrast:#ffffff;
      --soft-bg:#f1f5f9;
      --soft-hover:#e9eef5;
      --outline:#cbd5f5;
      --accent:#2563eb;
      --panel-shadow: 0 10px 30px rgba(15,23,42,.08);
    }

    [data-theme="cream"]{
      --bd:#d5c1b1;
      --muted:#6d5d52;
      --bg:#edddce;
      --surface:#cdbaa9;
      --text:#2c1d1f;
      --primary:#4b2743;
      --primary-contrast:#fdf6f2;
      --soft-bg:#e0cdbd;
      --soft-hover:#d6c2b2;
      --outline:#4b2743;
      --accent:#4b2743;
      --panel-shadow: 0 12px 30px rgba(75,39,67,.2);
    }

    [data-theme="white"]{
      --bd:#e6e8eb;
      --muted:#6b7280;
      --bg:#f8fafc;
      --surface:#ffffff;
      --text:#0f172a;
      --primary:#2563eb;
      --primary-contrast:#ffffff;
      --soft-bg:#f1f5f9;
      --soft-hover:#e9eef5;
      --outline:#cbd5f5;
      --accent:#2563eb;
      --panel-shadow: 0 10px 30px rgba(15,23,42,.08);
    }

    body{
      background:var(--bg);
      color:var(--text);
    }
    .topbar{
      background:var(--surface);
      border-bottom:1px solid var(--bd);
      position:sticky; top:0; z-index:1000;
    }
    .sitewrap{ max-width: 1200px; }
    .panel{
      background:var(--surface);
      border:1px solid var(--bd);
      border-radius:12px;
      box-shadow: var(--panel-shadow);
    }
    .panel-header{
      border-bottom:1px solid var(--bd);
      padding:.75rem 1rem;
      font-weight:600;
    }
    .panel-body{ padding:1rem; background:#ffffff; }
    .meta-row{ color:var(--muted); font-size:.9rem; }
    .passage-title{ font-size:1.25rem; font-weight:700; }
    .passage-text{ font-size:1.05rem; line-height:1.85; }
    .orig-text{ font-size:1.05rem; line-height:1.85; }
   .verse-num{ color:var(--accent); font-weight:700; margin-right:.25rem; font-size:.85em; }
    .btn-soft{ background:#4b2743; border:1px solid; border-color:#4b2743; color:#ffffff; }
    .btn-soft:hover{ background:#ffffff; }

    .btn-primary{
      background:var(--primary);
      border-color:var(--primary);
      color:var(--primary-contrast);
    }
    .btn-primary:hover{
      background:color-mix(in srgb, var(--primary) 85%, #000);
      border-color:color-mix(in srgb, var(--primary) 85%, #000);
      color:var(--primary-contrast);
    }

    .btn-outline-primary{
      color:var(--primary);
      border-color:var(--primary);
    }
    .btn-outline-primary:hover{
      background:var(--primary);
      color:var(--primary-contrast);
    }
     [data-theme="cream"] .btn-primary,
    [data-theme="cream"] .btn-outline-primary{
      background:#4b2743;
      border-color:#4b2743;
      color:#ffffff;
    }
    [data-theme="cream"] .btn-primary:hover,
    [data-theme="cream"] .btn-outline-primary:hover{
      background:#ffffff;
      border-color:#4b2743;
      color:#000000;
    }
[data-theme="white"] .btn-primary,
    [data-theme="white"] .btn-outline-primary{
      background:#ffffff;
      border-color:#2563eb;
      color:#2563eb;
    }
    [data-theme="white"] .btn-primary:hover,
    [data-theme="white"] .btn-outline-primary:hover{
      background:#eff6ff;
      border-color:#2563eb;
      color:#1d4ed8;
    }
   [data-theme="white"] .btn-soft{
      background:#ffffff;
      border-color:#2563eb;
      color:#2563eb;
    }
    [data-theme="white"] .btn-soft:hover{
      background:#eff6ff;
      border-color:#2563eb;
      color:#1d4ed8;
    }
    
    .text-muted{
      color:var(--muted) !important;
    }

    .form-control,
    .form-select{
     background:#ffffff;
      border-color:color-mix(in srgb, var(--text) 55%, #ffffff);
      color:var(--text);
    }
    .form-control::placeholder{ color:color-mix(in srgb, var(--muted) 80%, transparent); }

    .dropdown-menu{
      background:#ffffff;
      border-color:var(--bd);
      box-shadow: var(--panel-shadow);
    }
    .dropdown-item{ color:var(--text); }
    .dropdown-item:hover{ background:var(--soft-bg); color:var(--text); }

    .theme-dot{
      width: 14px; height: 14px; border-radius:50%;
      border:1px solid color-mix(in srgb, var(--text) 20%, transparent);
      display:inline-block;
      margin-right:.5rem;
    }
    .sticky-aside{ position: sticky; top: 86px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    /* Layout paralelo (español izquierda / original derecha) con colapsado del original */
    .parallel{ display:flex; flex-wrap:wrap; gap:1rem; }
    .parallel-col{ flex:1 1 360px; min-width:320px; }
    .orig-hidden #origCol{ display:none !important; }
    .orig-hidden #spanishCol{ flex:1 1 100%; min-width:100%; }
     .interlinear-mode #spanishCol{ display:none !important; }
    .interlinear-mode #origCol{ flex:1 1 100%; min-width:100%; }
     .interlinear-verse{
      margin-bottom:.6rem;
      display:flex;
      align-items:flex-start;
      gap:.35rem;
    }
    .interlinear-verse .verse-num{
      margin-right:0;
      margin-top:.06em;
      line-height:1.25;
      flex:0 0 auto;
    }
    .interlinear-original{ display:block; direction:rtl; unicode-bidi:plaintext; }
    .interlinear-grid{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      gap:.35rem .75rem;
      direction:rtl;
      unicode-bidi:plaintext;
    }
    .interlinear-word{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      min-width:max-content;
      line-height:1.25;
      font-size:1.4rem;
    }
    .interlinear-hebrew{
      font-family: 'SBL Hebrew','Ezra SIL','Times New Roman',serif;
      direction:rtl;
      unicode-bidi:plaintext;
    }
    .interlinear-spanish{
      margin-top:.1rem;
      color:var(--muted);
      direction:rtl;
      unicode-bidi:plaintext;
      text-align:center;
      white-space:nowrap;
    }

    /* Columna de herramientas a la izquierda, más compacta */
    .tools-panel .panel-body{ padding:.75rem; }
    .tools-panel .btn{ padding:.4rem .6rem; font-size:.9rem; }

     .page-nav{ display:flex; flex-wrap:wrap; gap:.5rem; }
    .page-nav .btn{ display:flex; align-items:center; gap:.35rem; }
    /* Greek font */
    .greek{
      font-family: 'Gentium Plus','SBL Greek','Times New Roman',serif;
      font-size: 1.1rem;
      line-height: 1.8;
    }

    .hebrew{
      direction: rtl;
      unicode-bidi: plaintext;
      font-family: 'SBL Hebrew','Ezra SIL','Times New Roman',serif;
      font-size: 1.4rem;
      line-height: 1.9;
    }
.verse-added{
      background: #fef08a;
      color: #7c2d12;
      padding: 0 .2em;
      border-radius: .25em;
      font-weight: 700;
    }
    /* Feedback animation */
    .feedback-badge{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.25rem .55rem;
      border-radius:999px;
      border:1px solid var(--bd);
      background:var(--soft-bg);
      font-size:.85rem;
      user-select:none;
      white-space:nowrap;
    }
    .feedback-badge.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .feedback-badge.err{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }

    .feedback-animate-pop{ animation: pop .18s ease-out; }
    .feedback-animate-shake{ animation: shake .28s ease-in-out; }

    .icon-check{
      width:14px;height:14px; display:inline-block;
      border-radius:50%;
      border:2px solid currentColor;
      position:relative;
    }
    .icon-check:after{
      content:"";
      position:absolute;
      left:3px; top:1px;
      width:4px; height:8px;
      border-right:2px solid currentColor;
      border-bottom:2px solid currentColor;
      transform:rotate(35deg);
    }

    .icon-x{
      width:14px;height:14px; display:inline-block;
      border-radius:50%;
      border:2px solid currentColor;
      position:relative;
    }
    .icon-x:before, .icon-x:after{
      content:"";
      position:absolute;
      left:5px; top:2px;
      width:2px; height:8px;
      background:currentColor;
      transform:rotate(45deg);
    }
    .icon-x:after{ transform:rotate(-45deg); }

    @keyframes pop{
      from{ transform:scale(.92); opacity:.6; }
      to{ transform:scale(1); opacity:1; }
    }
    @keyframes shake{
      0%{ transform:translateX(0); }
      25%{ transform:translateX(-3px); }
      50%{ transform:translateX(3px); }
      75%{ transform:translateX(-2px); }
      100%{ transform:translateX(0); }
    }

    .ctx-menu{
  position: fixed;
  z-index: 99999;
 background: var(--surface);
  border: 1px solid var(--bd);
  border-radius: 12px;
  box-shadow: 0 12px 30px rgba(0,0,0,.12);
  padding: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  user-select: none;
}

.ctx-dot{
  width: 22px; height: 22px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.08);
  cursor: pointer;
}

.ctx-sep{
  width:1px; height: 22px;
  background:var(--bd);
  margin: 0 2px;
}

.ctx-btn{
  width: 30px; height: 30px;
  border-radius: 10px;
 border: 1px solid var(--bd);
  background: var(--soft-bg);
  display:flex; align-items:center; justify-content:center;
  cursor: pointer;
}
.ctx-btn:hover{ background:var(--soft-hover); }
    .ctx-btn svg{ width: 16px; height: 16px; opacity:.85; }

    .notas-panel{
  border: 1px solid rgba(0,0,0,.15);
  border-radius: .5rem;
  padding: .5rem;
  background: var(--surface);
}

.notas-toolbar{
  margin-bottom: .5rem;
}

.notas-list{
  max-height: 260px;      /* ajusta a tu diseño */
  overflow: auto;
}

.notas-item{
  display: flex;
  flex-direction: column;
  gap: .15rem;
}

.notas-item small{
  opacity: .75;
}
.notas-panel { padding: .4rem; }
.notas-toolbar { margin-bottom: .35rem; }

.notas-list{
  max-height: 320px;
  overflow: auto;
}

.notas-item{
  padding: .35rem .5rem !important;
  line-height: 1.15;
}

.notas-item > div{
  display: flex;
  gap: .35rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.notas-item strong{
  font-size: .85rem;
}

.note-firstword{
  font-size: .8rem;
  opacity: .7;
}

.notas-item small{
  display: none !important;
}
  </style>


<!-- ✅ ANTES del script grande: DB + UI (notas + highlights) -->
<script defer src="./annotations-db.js?v=2"></script>
<script defer src="./annotations-ui.js?v=4"></script>
<script defer src="./listanotas.js?v=1"></script>
  <script defer src="./backup-panel.js?v=1"></script>
  <script defer src="./interlinear-view.js?v=1"></script>
  <script src="./greek-lexicon-ui.js"></script>
   <script src="./hebrew-lexicon-ui.js"></script>
<script src="./diccionario/greek-lexicon.js?v=12"></script>


<script>
  window.addEventListener('DOMContentLoaded', () => {
    if (window.GreekLexicon?.init) window.GreekLexicon.init();
  });
</script>





</head>


<body>
  <!-- TOP SEARCH BAR -->
  <header class="topbar">
    <div class="container sitewrap py-2">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 gap-lg-3">
        <div class="d-flex align-items-center gap-2 flex-grow-1">
          <span class="badge text-bg-dark rounded-pill">Lector</span>
          <form id="searchForm" class="d-flex gap-2 flex-grow-1">
            <input id="searchInput" class="form-control" value="1 Corintios 13:1-7" placeholder="Buscar: ej. 1 Corintios 13 / 1Co 13:1-7"/>
            <select id="versionSelect" class="form-select" style="max-width:180px">
              <option value="RVR1960" selected>RVR1960</option>
            </select>
            <button class="btn btn-primary" type="submit">Buscar</button>
          </form>
        </div>

        <div class="d-flex gap-2">
          <div class="dropdown">
            <button class="btn btn-soft btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="themeMenuBtn">
              Tema
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeMenuBtn">
              <li>
                <button class="dropdown-item d-flex align-items-center" type="button" data-theme="cream">
                  <span class="theme-dot" style="background:#edddce;"></span>Crema principal
                </button>
              </li>
              <li>
                <button class="dropdown-item d-flex align-items-center" type="button" data-theme="white">
                  <span class="theme-dot" style="background:#ffffff;"></span>Blanco
                </button>
              </li>
            </ul>
          </div>
          <button id="btnCopyText" class="btn btn-soft btn-sm" type="button">Copiar</button>
          <button id="btnViewMode" class="btn btn-soft btn-sm" type="button">Paralelo</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container sitewrap my-3 my-lg-4">
    <!-- Header: título + versión (sin navegación) -->
    <div class="d-flex flex-column gap-2 mb-3" style="margin-top:-20px;">
      <div class="d-flex flex-column flex-md-row justify-content-between gap-2 align-items-md-start">
        <div>
          <div class="passage-title" id="pageTitle">—</div>
          <div class="meta-row">
            Versión: <span class="fw-semibold" id="metaVersion">—</span>
          </div>
          <div class="page-nav mt-2" aria-label="Navegación de pasaje">
            <button id="btnPrevPage" class="btn btn-outline-primary btn-sm" type="button" disabled>
              <span aria-hidden="true">←</span>
              <span>Anterior</span>
            </button>
            <button id="btnNextPage" class="btn btn-outline-primary btn-sm" type="button" disabled>
              <span>Siguiente</span>
              <span aria-hidden="true">→</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- LEFT TOOLS (compact) -->
      <aside class="col-12 col-lg-2">
        <div class="sticky-aside d-flex flex-column gap-3">
          <section class="panel tools-panel">
            <div class="panel-header">Herramientas</div>
            <div class="panel-body d-grid gap-2">
              <a class="btn btn-outline-primary w-100" href="analisis.html">Análisis textual</a>
            <button id="btnNotas" type="button" class="btn btn-outline-primary">
    Notas
  </button>
              <!-- Panel desplegable (queda exactamente debajo del botón) -->
  <div id="notasPanel" class="notas-panel d-none">
    <div class="notas-toolbar">
      <input id="notasSearch" class="form-control form-control-sm" placeholder="Buscar cita o palabra...">
    </div>
    <div id="notasList" class="list-group notas-list"></div>
  </div>

              <button class="btn btn-soft w-100" type="button" id="btnRKANTEs">
  Aparato crítico RKANT
</button>

            </div>
          </section>

          <div id="backupPanelMount"></div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="col-12 col-lg-10">
        <section class="panel">
          <div class="panel-header d-flex justify-content-between align-items-center gap-2">
            <span id="panelHeaderTitle">Texto del pasaje</span>

            <div class="d-flex align-items-center gap-2">
              <span class="text-muted" style="font-weight:400; font-size:.9rem" id="statusLine"></span>
              <span id="feedbackBadge" class="feedback-badge" style="display:none"></span>
              <button id="btnToggleOrig" class="btn btn-soft btn-sm" type="button" aria-expanded="true">
                Ocultar original
              </button>
            </div>
          </div>

<div class="panel-body">

  <!-- ===== TEXTO BÍBLICO NORMAL (RVR + ORIGINAL) ===== -->
  <div id="biblePanel">
    <div class="parallel">
      <!-- IZQUIERDA: Español -->
      <div id="spanishCol" class="parallel-col">
        <div class="fw-semibold mb-2" id="leftLabel">RVR1960</div>
        <div class="passage-text" id="passageTextRV">
          <div class="text-muted">Cargando datos…</div>
        </div>
      </div>

      <!-- DERECHA: Original -->
      <div id="origCol" class="parallel-col">
        <div class="fw-semibold mb-2" id="rightLabel">Original</div>
        <div class="orig-text" id="passageTextOrig">
          <div class="text-muted">Cargando datos…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== PANEL RKANT-ES (OCULTO POR DEFECTO) ===== -->
  <div id="rkantPanel" class="d-none mt-3">

    <!-- Selectores -->
    <div class="row g-2 mb-2">
      <div class="col-12 col-md-4">
        <select id="rkantBook" class="form-select form-select-sm"></select>
      </div>
      <div class="col-6 col-md-4">
        <select id="rkantChapter" class="form-select form-select-sm"></select>
      </div>
      <div class="col-6 col-md-4">
        <select id="rkantVerse" class="form-select form-select-sm"></select>
      </div>
    </div>

    <!-- Contenido RKANT -->
    <div id="rkantViewer"></div>

  </div>

</div>

        </section>

      </div>
    </div>
  </main>

  <script>
/***********************
 * Config
 ***********************/
const params = new URLSearchParams(window.location.search);

const RV_BASE = params.get('rvBase') || './librosRV1960/';
const GRIEGO_PATH = './IdiomaORIGEN/Bgriega.json';

// ✅ Hebreo por libro (con nikkud): IdiomaORIGEN/genesis.json, exodo.json, amos.json, etc.
const HEBREO_BOOK_BASE = params.get('heBase') || './IdiomaORIGEN/';

// Si quieres forzar ocultar original por defecto: ?orig=0
const ORIGINAL_ENABLED_DEFAULT = (params.get('orig') ?? '1') !== '0';

// Estado actual (se puede cambiar desde el buscador)
let currentBookSlug = (params.get('book') || '1_corintios').trim();
let currentBookName = (params.get('name') || prettyBookName(currentBookSlug));

/***********************
 * Canon + aliases (Genesis -> Apocalipsis)
 ***********************/
const NT_BOOKS = new Set([
  'mateo','marcos','lucas','juan','hechos',
  'romanos','1_corintios','2_corintios','galatas','efesios','filipenses','colosenses',
  '1_tesalonicenses','2_tesalonicenses','1_timoteo','2_timoteo','tito','filemon',
  'hebreos','santiago','1_pedro','2_pedro','1_juan','2_juan','3_juan','judas','apocalipsis'
]);
function isNT(slug){ return NT_BOOKS.has(slug); }

function normalizeKey(s){
  return (s || '')
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,'')
    .replace(/\./g,'')
    .replace(/\s+/g,'')
    .trim();
}
function prettyBookName(slug){
  return (slug || '').replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
}
function slugifyBookName(name){
  return (name || '')
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,'')
    .replace(/\./g,'')
    .trim()
    .replace(/\s+/g,' ')
    .replace(/^(\d)\s+/, '$1 ')
    .replace(/\s/g,'_');
}

// Aliases amplios (comunes). La clave es "normalizada" (sin espacios ni tildes)
const BOOK_ALIASES = {
  // Pentateuco
  'genesis':'genesis','gen':'genesis','gn':'genesis',
  'exodo':'exodo','exo':'exodo','ex':'exodo',
  'levitico':'levitico','lev':'levitico','lv':'levitico',
  'numeros':'numeros','num':'numeros','nm':'numeros',
  'deuteronomio':'deuteronomio','deut':'deuteronomio','dt':'deuteronomio',

  // Históricos
  'josue':'josue','jos':'josue',
  'jueces':'jueces','jue':'jueces','jdg':'jueces',
  'rut':'rut','rt':'rut',
  '1samuel':'1_samuel','1sa':'1_samuel','1sam':'1_samuel',
  '2samuel':'2_samuel','2sa':'2_samuel','2sam':'2_samuel',
  '1reyes':'1_reyes','1rey':'1_reyes','1ki':'1_reyes','1kgs':'1_reyes',
  '2reyes':'2_reyes','2rey':'2_reyes','2ki':'2_reyes','2kgs':'2_reyes',
  '1cronicas':'1_cronicas','1cro':'1_cronicas','1cr':'1_cronicas',
  '2cronicas':'2_cronicas','2cro':'2_cronicas','2cr':'2_cronicas',
  'esdras':'esdras','esd':'esdras','ezra':'esdras',
  'nehemias':'nehemias','neh':'nehemias',
  'ester':'ester','est':'ester',

  // Poéticos
  'job':'job','jb':'job',
  'salmos':'salmos','salmo':'salmos','sal':'salmos','ps':'salmos',
  'proverbios':'proverbios','prov':'proverbios','pr':'proverbios',
  'eclesiastes':'eclesiastes','ecl':'eclesiastes','ec':'eclesiastes',
  'cantares':'cantares','cantar':'cantares','cnt':'cantares','cant':'cantares',

  // Profetas mayores
  'isaias':'isaias','isa':'isaias',
  'jeremias':'jeremias','jer':'jeremias',
  'lamentaciones':'lamentaciones','lam':'lamentaciones',
  'ezequiel':'ezequiel','eze':'ezequiel','ez':'ezequiel',
  'daniel':'daniel','dan':'daniel',

  // Profetas menores
  'oseas':'oseas','os':'oseas',
  'joel':'joel','jl':'joel',
  'amos':'amos','am':'amos',
  'abdias':'abdias','abd':'abdias','obadias':'abdias','obad':'abdias',
  'jonas':'jonas','jon':'jonas',
  'miqueas':'miqueas','miq':'miqueas','mic':'miqueas',
  'nahum':'nahum','nah':'nahum',
  'habacuc':'habacuc','hab':'habacuc',
  'sofonias':'sofonias','sof':'sofonias','zep':'sofonias',
  'hageo':'hageo','hag':'hageo',
  'zacarias':'zacarias','zac':'zacarias','zec':'zacarias',
  'malaquias':'malaquias','mal':'malaquias',

  // Evangelios / Hechos
  'mateo':'mateo','mt':'mateo',
  'marcos':'marcos','mr':'marcos','mk':'marcos',
  'lucas':'lucas','lc':'lucas','lk':'lucas',
  'juan':'juan','jn':'juan','jhn':'juan',
  'hechos':'hechos','hch':'hechos','actos':'hechos','act':'hechos',

  // Paulinas
  'romanos':'romanos','rom':'romanos',
  '1corintios':'1_corintios','1cor':'1_corintios','1co':'1_corintios',
  '2corintios':'2_corintios','2cor':'2_corintios','2co':'2_corintios',
  'galatas':'galatas','gal':'galatas',
  'efesios':'efesios','efe':'efesios','eph':'efesios',
  'filipenses':'filipenses','fil':'filipenses','php':'filipenses',
  'colosenses':'colosenses','col':'colosenses',
  '1tesalonicenses':'1_tesalonicenses','1tes':'1_tesalonicenses','1th':'1_tesalonicenses',
  '2tesalonicenses':'2_tesalonicenses','2tes':'2_tesalonicenses','2th':'2_tesalonicenses',
  '1timoteo':'1_timoteo','1tim':'1_timoteo',
  '2timoteo':'2_timoteo','2tim':'2_timoteo',
  'tito':'tito','tit':'tito',
  'filemon':'filemon','flm':'filemon','phm':'filemon',
  'hebreos':'hebreos','heb':'hebreos',

  // Generales + Apocalipsis
  'santiago':'santiago','stg':'santiago','jas':'santiago',
  '1pedro':'1_pedro','1pe':'1_pedro','1pet':'1_pedro',
  '2pedro':'2_pedro','2pe':'2_pedro','2pet':'2_pedro',
  '1juan':'1_juan','1jn':'1_juan','1j':'1_juan',
  '2juan':'2_juan','2jn':'2_juan','2j':'2_juan',
  '3juan':'3_juan','3jn':'3_juan','3j':'3_juan',
  'judas':'judas','jud':'judas',
  'apocalipsis':'apocalipsis','apo':'apocalipsis','apoc':'apocalipsis','rev':'apocalipsis'
};

    const BOOK_ORDER = [
  'genesis','exodo','levitico','numeros','deuteronomio',
  'josue','jueces','rut','1_samuel','2_samuel','1_reyes','2_reyes','1_cronicas','2_cronicas',
  'esdras','nehemias','ester','job','salmos','proverbios','eclesiastes','cantares',
  'isaias','jeremias','lamentaciones','ezequiel','daniel','oseas','joel','amos','abdias',
  'jonas','miqueas','nahum','habacuc','sofonias','hageo','zacarias','malaquias',
  'mateo','marcos','lucas','juan','hechos','romanos','1_corintios','2_corintios',
  'galatas','efesios','filipenses','colosenses','1_tesalonicenses','2_tesalonicenses',
  '1_timoteo','2_timoteo','tito','filemon','hebreos','santiago','1_pedro','2_pedro',
  '1_juan','2_juan','3_juan','judas','apocalipsis'
];
function resolveBookSlug(bookRaw){
  const key = normalizeKey(bookRaw);
  if(BOOK_ALIASES[key]) return BOOK_ALIASES[key];

  // Manejo "1 cor" -> "1cor"
  const key2 = key.replace(/^([123])/, '$1');
  if(BOOK_ALIASES[key2]) return BOOK_ALIASES[key2];

  return slugifyBookName(bookRaw);
}

/***********************
 * Mapeos para Original (book_name dentro de los JSON grandes)
 ***********************/
const NT_TR_BOOKNAME = {
  mateo: 'Matthew', marcos: 'Mark', lucas: 'Luke', juan: 'John', hechos: 'Acts',
  romanos: 'Romans', '1_corintios': '1 Corinthians', '2_corintios': '2 Corinthians',
  galatas: 'Galatians', efesios: 'Ephesians', filipenses: 'Philippians', colosenses: 'Colossians',
  '1_tesalonicenses': '1 Thessalonians', '2_tesalonicenses': '2 Thessalonians',
  '1_timoteo': '1 Timothy', '2_timoteo': '2 Timothy', tito: 'Titus', filemon: 'Philemon',
  hebreos: 'Hebrews', santiago: 'James', '1_pedro': '1 Peter', '2_pedro': '2 Peter',
  '1_juan': '1 John', '2_juan': '2 John', '3_juan': '3 John', judas: 'Jude', apocalipsis: 'Revelation'
};

/***********************
 * DOM
 ***********************/
const form = document.getElementById('searchForm');
const searchInput = document.getElementById('searchInput');
const versionSelect = document.getElementById('versionSelect');
const metaVersion = document.getElementById('metaVersion');
const pageTitle = document.getElementById('pageTitle');
const statusLine = document.getElementById('statusLine');

const passageTextRV = document.getElementById('passageTextRV');
const passageTextOrig = document.getElementById('passageTextOrig');

const leftLabel = document.getElementById('leftLabel');
const rightLabel = document.getElementById('rightLabel');


const btnCopyText = document.getElementById('btnCopyText');
const btnViewMode = document.getElementById('btnViewMode');
const btnToggleOrig = document.getElementById('btnToggleOrig');
    const btnPrevPage = document.getElementById('btnPrevPage');
const btnNextPage = document.getElementById('btnNextPage');
const themeMenuBtn = document.getElementById('themeMenuBtn');
const themeMenu = themeMenuBtn?.nextElementSibling;
const themeItems = document.querySelectorAll('.dropdown-item[data-theme]');
/***********************
 * Data / caches
 ***********************/
let lastRef = null;
const rvCache = {};                 // slug -> chapters[][]
let trData = null;                  // NT griego completo (verses[])
const trChaptersCache = {};         // slug -> chapters[][]

// ✅ Hebreo por libro (cada archivo ya trae text[][])
const heBookCache = {};             // slug -> chapters[][]
    const jsonCache = new Map();

let bookDataRV = null;
let bookDataOrig = null;
let pendingRestoreState = null;
let viewMode = 'parallel';
/***********************
 * Helpers
 ***********************/
function esc(s){
  return (s ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#39;");
}
function fmtVerse(raw){
  // normaliza: "/n", "\\n" y saltos reales -> "\n"
  const normalized = String(raw ?? '').replace(/\/n|\\n/g, '\n');
  // escapa HTML y luego convierte saltos a <br>
  return esc(normalized).replace(/\n/g, '<br>');
}
function fmtOrigVerse(raw, isGreek){
  const normalized = String(raw ?? '').replace(/\/n|\\n/g, '\n');
  if(!isGreek) return esc(normalized).replace(/\n/g, '<br>');

  const phraseRe = /verso añadido no existe\./gi;
  if(!phraseRe.test(normalized)) return esc(normalized).replace(/\n/g, '<br>');

  phraseRe.lastIndex = 0;
  let out = '';
  let last = 0;
  for(const match of normalized.matchAll(phraseRe)){
    const idx = match.index ?? 0;
    out += esc(normalized.slice(last, idx));
    out += `<span class="verse-added">${esc(match[0])}</span>`;
    last = idx + match[0].length;
  }
  out += esc(normalized.slice(last));
  return out.replace(/\n/g, '<br>');
}
    function buildInterlinearWordMarkup(rows, fallbackText){
  const tokens = Array.isArray(rows?.tokens) ? rows.tokens : [];
  const spanishTokens = Array.isArray(rows?.spanishTokens) ? rows.spanishTokens : [];
  if(!tokens.length){
    return `<span class="interlinear-hebrew">${fmtOrigVerse(fallbackText || '-', false)}</span>`;
  }

  const words = tokens.map((token, idx) => {
    const hebrewWord = esc(token || '-');
    const spanishWord = esc(spanishTokens[idx] || '-');
    return `<span class="interlinear-word"><span class="interlinear-hebrew">${hebrewWord}</span><span class="interlinear-spanish">${spanishWord}</span></span>`;
  });

  return `<span class="interlinear-grid">${words.join('')}</span>`;
}
function updateViewModeButton(){
  if(!btnViewMode) return;
   btnViewMode.textContent = viewMode === 'interlinear' ? 'Interlineal (AT)' : 'Paralelo';
}

function isInterlinearAvailable(){
  return !isNT(currentBookSlug);
}

function setViewMode(mode){
   const requestedInterlinear = mode === 'interlinear';
  viewMode = (requestedInterlinear && isInterlinearAvailable()) ? 'interlinear' : 'parallel';
  document.body.classList.toggle('interlinear-mode', viewMode === 'interlinear');
  updateViewModeButton();
  if(lastRef){
    render({ chapter: lastRef.chapter, verseStart: lastRef.verseStart, verseEnd: lastRef.verseEnd });
  }
}
function normalizeSpaces(s){
  return (s || '').trim().replace(/\s+/g,' ');
}
    function buildLastReferenceSearch(){
  if(!lastRef?.chapter) return '';
  const chapter = Number(lastRef.chapter);
  const verseStart = Number(lastRef.verseStart);
  const verseEnd = Number(lastRef.verseEnd);
  if(Number.isFinite(verseStart) && Number.isFinite(verseEnd) && verseStart > 0 && verseEnd >= verseStart){
    if(verseStart === verseEnd) return `${prettyBookName(currentBookSlug)} ${chapter}:${verseStart}`;
    return `${prettyBookName(currentBookSlug)} ${chapter}:${verseStart}-${verseEnd}`;
  }
  return `${prettyBookName(currentBookSlug)} ${chapter}`;
}
async function loadJson(path){
 if (jsonCache.has(path)) return jsonCache.get(path);
  const promise = fetch(path, { cache: 'force-cache' }).then(async (r) => {
    if(!r.ok) throw new Error(`No se pudo cargar ${path} (HTTP ${r.status})`);
    return await r.json();
  });
  jsonCache.set(path, promise);
  try{
    return await promise;
  }catch(error){
    jsonCache.delete(path);
    throw error;
  }
}

async function copy(text){
  try{ await navigator.clipboard.writeText(text); }catch{}
}
    function saveReaderState(){
  try{
    const state = {
      url: location.href,
      scrollY: window.scrollY || 0,
      origHidden: document.body.classList.contains('orig-hidden') ? 1 : 0,
      currentBookSlug: currentBookSlug || null,
      currentBookName: currentBookName || null,
     lastSearch: (document.getElementById('searchInput')?.value || '').trim(),
      lastReferenceSearch: buildLastReferenceSearch()
    };
    sessionStorage.setItem('lectorState', JSON.stringify(state));
  }catch{}
}
function applyTheme(theme){
 const allowedThemes = new Set(['cream', 'white']);
  const safeTheme = allowedThemes.has(theme) ? theme : 'cream';
  document.documentElement.dataset.theme = safeTheme;
  localStorage.setItem('lectorTheme', safeTheme);
}
    async function getChapterCount(slug){
  if(rvCache[slug]) return rvCache[slug].length;
  const path = `${RV_BASE}${slug}.json`;
  rvCache[slug] = await loadJson(path);
  return rvCache[slug].length;
}

function buildSearchString(slug, chapter){
  return `${prettyBookName(slug)} ${chapter}`;
}

function formatNavButtonLabel(direction, target){
  const label = target ? `${prettyBookName(target.slug)} ${target.chapter}` : '';
  const icon = direction === 'prev' ? '←' : '→';
  const text = direction === 'prev' ? 'Anterior' : 'Siguiente';
  const labelHtml = label ? ` <span class="d-none d-md-inline text-muted ms-1">${esc(label)}</span>` : '';
  return direction === 'prev'
    ? `<span aria-hidden="true">${icon}</span><span>${text}</span>${labelHtml}`
    : `<span>${text}</span>${labelHtml}<span aria-hidden="true">${icon}</span>`;
}

function setNavButton(button, direction, target){
  if(!button) return;
  button.disabled = !target;
  button.dataset.book = target?.slug || '';
  button.dataset.chapter = target?.chapter || '';
  button.innerHTML = formatNavButtonLabel(direction, target);
  button.title = target ? `${prettyBookName(target.slug)} ${target.chapter}` : '';
}

async function updatePageNav(chapterCount){
  if(!btnPrevPage || !btnNextPage || !lastRef) return;
  const currentChapter = lastRef.chapter;
  const idx = BOOK_ORDER.indexOf(currentBookSlug);
  let prevTarget = null;
  let nextTarget = null;

  if(currentChapter > 1){
    prevTarget = { slug: currentBookSlug, chapter: currentChapter - 1 };
  }else if(idx > 0){
    const prevSlug = BOOK_ORDER[idx - 1];
    const prevChapterCount = await getChapterCount(prevSlug);
    prevTarget = { slug: prevSlug, chapter: prevChapterCount };
  }

  if(currentChapter < chapterCount){
    nextTarget = { slug: currentBookSlug, chapter: currentChapter + 1 };
  }else if(idx >= 0 && idx < BOOK_ORDER.length - 1){
    const nextSlug = BOOK_ORDER[idx + 1];
    nextTarget = { slug: nextSlug, chapter: 1 };
  }

  setNavButton(btnPrevPage, 'prev', prevTarget);
  setNavButton(btnNextPage, 'next', nextTarget);
}

async function navigateToPage(slug, chapter){
  if(!slug || !chapter) return;
  searchInput.value = buildSearchString(slug, chapter);
  await ensureBookLoaded(slug, prettyBookName(slug));
  leftLabel.textContent = versionSelect.value;
  await render({ chapter, verseStart: null, verseEnd: null });
}
/***********************
 * Builder: verses[] -> chapters[][]
 ***********************/
function buildChaptersFromVersesForBook(allVerses, bookName){
  if(!bookName || !Array.isArray(allVerses)) return null;

  const verses = allVerses.filter(v => v && v.book_name === bookName);

  let maxCh = 0;
  const maxVerseByCh = {};
  for(const v of verses){
    const ch = Number(v.chapter);
    const vs = Number(v.verse);
    if(Number.isFinite(ch) && ch > maxCh) maxCh = ch;
    if(!maxVerseByCh[ch] || vs > maxVerseByCh[ch]) maxVerseByCh[ch] = vs;
  }
  if(maxCh <= 0) return null;

  const chapters = Array.from({length: maxCh}, (_, i) => {
    const ch = i+1;
    const len = maxVerseByCh[ch] || 0;
    return Array.from({length: len}, () => '');
  });

  for(const v of verses){
    const ch = Number(v.chapter);
    const vs = Number(v.verse);
    if(ch >= 1 && ch <= chapters.length && vs >= 1 && vs <= chapters[ch-1].length){
      chapters[ch-1][vs-1] = v.text || '';
    }
  }
  return chapters;
}

/***********************
 * Cargar libro: Español + (opcional) Original
 ***********************/
async function ensureBookLoaded(slug, displayName){
  // Español (requerido)
  if(!rvCache[slug]){
    const path = `${RV_BASE}${slug}.json`;
    rvCache[slug] = await loadJson(path);
  }
  bookDataRV = rvCache[slug];

  // Original (opcional). Si falla, NO tumba el español.
  bookDataOrig = null;

  if(!ORIGINAL_ENABLED_DEFAULT){
    rightLabel.textContent = 'Original (off)';
    passageTextOrig.innerHTML = `<div class="text-muted">Original desactivado.</div>`;
    return;
  }

  if(isNT(slug)){
    rightLabel.textContent = 'Griego';
    passageTextOrig.classList.remove('hebrew');
    passageTextOrig.classList.add('greek');

    try{
      if(!trData) trData = await loadJson(GRIEGO_PATH);
      if(!trChaptersCache[slug]){
        const bookName = NT_TR_BOOKNAME[slug];
        trChaptersCache[slug] = buildChaptersFromVersesForBook(trData.verses, bookName);
      }
      bookDataOrig = trChaptersCache[slug] || null;

      if(!bookDataOrig){
        passageTextOrig.innerHTML = `<div class="text-muted">Griego no disponible para este libro (revisa mapeo).</div>`;
      }
    }catch(err){
      passageTextOrig.innerHTML = `<div class="text-muted">Griego no disponible: ${esc(err.message || String(err))}</div>`;
      bookDataOrig = null;
    }

  } else {
    // ✅ AT: Hebreo por libro: IdiomaORIGEN/<slug>.json, con raíz: { metadata, text: [[...],[...]] }
    rightLabel.textContent = 'Hebreo';
    passageTextOrig.classList.remove('greek');
    passageTextOrig.classList.add('hebrew');

    try{
      if(!heBookCache[slug]){
        const path = `${HEBREO_BOOK_BASE}${slug}.json`;
        const heBook = await loadJson(path);

        if(!heBook || !Array.isArray(heBook.text)){
          throw new Error(`Estructura hebrea inválida en ${path}: falta "text" como array (chapters[][]).`);
        }

        // Normaliza a strings (por si hay nulls)
        heBookCache[slug] = heBook.text.map(ch => Array.isArray(ch) ? ch.map(v => (v ?? '')) : []);
      }

      bookDataOrig = heBookCache[slug] || null;

      if(!bookDataOrig){
        passageTextOrig.innerHTML = `<div class="text-muted">Hebreo no disponible para este libro.</div>`;
      }
    }catch(err){
      passageTextOrig.innerHTML = `<div class="text-muted">Hebreo no disponible: ${esc(err.message || String(err))}</div>`;
      bookDataOrig = null;
    }
  }

  currentBookSlug = slug;
  currentBookName = displayName || prettyBookName(slug);
}

/***********************
 * Parse búsqueda
 ***********************/
function parseSearch(raw){
  const q = normalizeSpaces(raw);
  if(!q) return null;

  // ✅ Solo acepta búsquedas que incluyan libro
   const m = q.match(/^(.+?)(?:\s+)?(\d+)(?::(\d+)(?:\s*-\s*(\d+))?)?\s*$/);
  if(!m) return null;

  const bookRaw = m[1];
  const slug = resolveBookSlug(bookRaw);
  const chapter = parseInt(m[2],10);
  const verseStart = m[3] ? parseInt(m[3],10) : null;
  const verseEnd = m[4] ? parseInt(m[4],10) : (verseStart ? verseStart : null);

  return { slug, bookDisplay: bookRaw, chapter, verseStart, verseEnd };
}

/***********************
 * Render
 ***********************/
function clearFeedback(){
  const b = document.getElementById('feedbackBadge');
  if(!b) return;
  b.style.display = 'none';
  b.className = 'feedback-badge';
  b.innerHTML = '';
}

function showFeedback(kind, text){
  const b = document.getElementById('feedbackBadge');
  if(!b) return;
  b.style.display = 'inline-flex';
  b.className = 'feedback-badge ' + (kind === 'ok' ? 'ok feedback-animate-pop' : 'err feedback-animate-shake');
  const icon = kind === 'ok' ? '<span class="icon-check" aria-hidden="true"></span>' : '<span class="icon-x" aria-hidden="true"></span>';
  b.innerHTML = icon + '<span>' + esc(text) + '</span>';
  setTimeout(() => b.classList.remove('feedback-animate-pop','feedback-animate-shake'), 350);
}
let syncVerseHeightsRaf = null;
function scheduleSyncVerseHeights(){
  if(syncVerseHeightsRaf) cancelAnimationFrame(syncVerseHeightsRaf);
  syncVerseHeightsRaf = requestAnimationFrame(() => {
    syncVerseHeightsRaf = null;
    syncVerseHeights();
  });
}

function syncVerseHeights(){
  const rvLines = passageTextRV.querySelectorAll('.verse-line[data-side="rv"]');
  const origLines = passageTextOrig.querySelectorAll('.verse-line[data-side="orig"]');

rvLines.forEach((line) => { line.style.minHeight = ''; });
  origLines.forEach((line) => { line.style.minHeight = ''; });

if(!bookDataOrig || document.body.classList.contains('orig-hidden') || viewMode === 'interlinear') return;

  const origByVerse = new Map();
  origLines.forEach((line) => { origByVerse.set(line.dataset.v, line); });

  rvLines.forEach((line) => {
    const twin = origByVerse.get(line.dataset.v);
    if(!twin) return;
const rvHeight = line.getBoundingClientRect().height;
    const origHeight = twin.getBoundingClientRect().height;
    const maxHeight = Math.max(rvHeight, origHeight);
    line.style.minHeight = `${maxHeight}px`;
    twin.style.minHeight = `${maxHeight}px`;
  });
}
async function render(ref){
  if(!bookDataRV) return;

  clearFeedback();

  const chapterCount = bookDataRV.length;

  // Validación: capítulo solicitado
  if(ref.chapter < 1 || ref.chapter > chapterCount){
    pageTitle.textContent = `${currentBookName} ${ref.chapter}`;
   metaVersion.textContent = viewMode === 'interlinear' ? 'Interlineal' : versionSelect.value;
  rightLabel.textContent = viewMode === 'interlinear' ? 'Texto original + Español' : (isNT(currentBookSlug) ? 'Griego' : 'Hebreo');
    statusLine.textContent = `Capítulos: ${chapterCount}`;
    passageTextRV.innerHTML = `<div class="text-muted">No existe el capítulo <strong>${esc(String(ref.chapter))}</strong> en <strong>${esc(currentBookName)}</strong>.</div>`;
    passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
    showFeedback('err', 'Verso / capítulo no encontrado');
    return;
  }

  const ch = ref.chapter;
  const versesRV = bookDataRV[ch-1] || [];
  const verseCount = versesRV.length;

  // Validación: versículo solicitado
  if(ref.verseStart != null){
    const v1req = ref.verseStart;
    const v2req = ref.verseEnd ?? v1req;
    if(v1req < 1 || v1req > verseCount || v2req < 1 || v2req > verseCount){
      pageTitle.textContent = `${currentBookName} ${ch}:${v1req}${(v2req!==v1req?'-'+v2req:'')}`;
      metaVersion.textContent = versionSelect.value;
      statusLine.textContent = `Capítulos: ${chapterCount} · Cap ${ch}: ${verseCount} vers.`;
      passageTextRV.innerHTML = `<div class="text-muted">No existe ese versículo en <strong>${esc(currentBookName)} ${ch}</strong>. Rango válido: 1–${verseCount}.</div>`;
      passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
      showFeedback('err', 'Verso / capítulo no encontrado');
      return;
    }
  }

  let v1 = ref.verseStart ?? 1;
  let v2 = ref.verseEnd ?? verseCount;
  if(v2 < v1) [v1, v2] = [v2, v1];

  lastRef = { chapter: ch, verseStart: v1, verseEnd: v2 };

  const range = (ref.verseStart == null)
    ? `${currentBookName} ${ch}`
    : `${currentBookName} ${ch}:${v1}${(v2 !== v1 ? '-' + v2 : '')}`;

  pageTitle.textContent = range;
 metaVersion.textContent = (viewMode === 'interlinear' && isInterlinearAvailable()) ? 'Interlineal' : versionSelect.value;

  // Español
  let htmlRV = '';
  for(let v=v1; v<=v2; v++){
    const t = versesRV[v-1] ?? '';
 htmlRV += `<p class="mb-2 verse-line" data-side="rv" data-book="${esc(currentBookSlug)}" data-ch="${ch}" data-v="${v}">
    <span class="verse-num">${v}</span><span class="verse-text">${fmtVerse(t)}</span>
    </p>`;

  }
  passageTextRV.innerHTML = htmlRV || `<div class="text-muted">Sin contenido para esta referencia.</div>`;

  // Original / interlineal
  if(bookDataOrig){
    const versesOrig = bookDataOrig[ch-1] || [];
    const isGreekBook = isNT(currentBookSlug);
    let htmlOrig = '';
    for(let v=v1; v<=v2; v++){
      const t = versesOrig[v-1] ?? '';
 if(viewMode === 'interlinear' && !isGreekBook){
        if(window.InterlinearView?.buildInterlinearRows){
           const rows = await window.InterlinearView.buildInterlinearRows(t);
          htmlOrig += `<p class="mb-2 verse-line interlinear-verse" data-side="orig" data-book="${esc(currentBookSlug)}" data-ch="${ch}" data-v="${v}">
            <span class="verse-num">${v}</span>
 <span class="interlinear-original">${buildInterlinearWordMarkup(rows, t)}</span>
          </p>`;
        }else{
          htmlOrig += `<p class="mb-2 verse-line interlinear-verse" data-side="orig" data-book="${esc(currentBookSlug)}" data-ch="${ch}" data-v="${v}">
            <span class="verse-num">${v}</span>
            <span class="interlinear-original">${fmtOrigVerse(t, false)}</span>
            <span class="interlinear-spanish">-</span>
          </p>`;
        }
      }else{
        htmlOrig += `<p class="mb-2 verse-line" data-side="orig" data-book="${esc(currentBookSlug)}" data-ch="${ch}" data-v="${v}">
           <span class="verse-num">${v}</span><span class="verse-text">${fmtOrigVerse(t, isGreekBook)}</span>
        </p>`;
      }
    }
    passageTextOrig.innerHTML = htmlOrig || `<div class="text-muted">Sin contenido original para esta referencia.</div>`;
    // ✅ Hacer cada palabra griega clickeable (antes de subrayados/notas)
 if(viewMode === 'parallel' && window.GreekLexicon?.decoratePassage) {
      window.GreekLexicon.decoratePassage(passageTextOrig, currentBookSlug, ch, v1, v2);
    }
  } else {
    passageTextOrig.innerHTML = `<div class="text-muted">Original no disponible para esta referencia.</div>`;
  }

  statusLine.textContent = `Capítulos: ${chapterCount} · Cap ${ch}: ${verseCount} vers.`;
  showFeedback('ok', 'Cita encontrada');
  updatePageNav(chapterCount);

  const userSearch = normalizeSpaces(searchInput.value) || range;
  history.replaceState(
    null,
    '',
      `?book=${encodeURIComponent(currentBookSlug)}&name=${encodeURIComponent(currentBookName)}&search=${encodeURIComponent(userSearch)}&version=${encodeURIComponent(versionSelect.value)}&orig=${ORIGINAL_ENABLED_DEFAULT?'1':'0'}&view=${viewMode}`
  );


// ✅ Aplicar subrayados y notas guardadas (IndexedDB) después de renderizar el DOM
if (window.AnnotationsUI_applyHighlightsToPassage) {
  window.AnnotationsUI_applyHighlightsToPassage(currentBookSlug, ch, v1, v2);
}
if (window.AnnotationsUI_applyNotesToPassage) {
  window.AnnotationsUI_applyNotesToPassage(currentBookSlug, ch, v1, v2);
}
  // ✅ Comentarios bíblicos (solo si hay JSON para ese capítulo)
if (window.BibleComments?.attachCommentsToRV) {
  window.BibleComments.attachCommentsToRV(passageTextRV, currentBookSlug, ch);
}

scheduleSyncVerseHeights();
  if (bookDataOrig && passageTextOrig.classList.contains('greek') && document.fonts?.ready) {
  document.fonts.ready.then(scheduleSyncVerseHeights).catch(() => {});
}
}


async function runSearch(){
  const raw = normalizeSpaces(searchInput.value);
  if(!raw){
    passageTextRV.innerHTML = `<div class="text-muted">Escribe una referencia.</div>`;
    passageTextOrig.innerHTML = `<div class="text-muted">Escribe una referencia.</div>`;
    return;
  }

  const ref = parseSearch(raw);

  // ✅ Si NO es una referencia, se interpreta como búsqueda por palabra/frase
  if(!ref){
    const q = raw.trim();
    if(q){
      const p = new URLSearchParams();
      p.set('q', q);
      p.set('mode', 'all');     // all | es | gr | he (tu busqueda.html)
      p.set('exact', '0');      // 1 si quieres exacta por defecto
      // Puedes pasar también la versión si luego la usas en busqueda.html
      p.set('version', versionSelect.value || 'RVR1960');

    // ✅ Guardar estado del lector (para restaurar si el navegador recarga)
saveReaderState();
      window.location.href = `./busqueda.html?${p.toString()}`;
      return;
    }

    // Si está vacío, muestra mensaje
    const msg = `<div class="text-muted">Escribe una referencia o una palabra.</div>`;
    passageTextRV.innerHTML = msg;
    passageTextOrig.innerHTML = msg;
    return;
  }


  try{
    await ensureBookLoaded(ref.slug, ref.bookDisplay);
    leftLabel.textContent = versionSelect.value;
    await render(ref);
  }catch(err){
    const msg = `<div class="text-danger fw-semibold">Error:</div><div class="text-muted">${esc(err.message || String(err))}</div>`;
    passageTextRV.innerHTML = msg;
    passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
    statusLine.textContent = '';
  }
}

/***********************
 * URL + UI
 ***********************/
function setFromUrl(){
  const p = new URLSearchParams(location.search);
  const q = p.get('search');
  const v = p.get('version');
  const bk = p.get('book');
  const nm = p.get('name');
  const view = p.get('view');

  if(bk) currentBookSlug = bk.trim();
  if(view === 'interlinear' && !isNT(currentBookSlug)) viewMode = 'interlinear';
  if(nm) currentBookName = nm.trim();
  if(q) searchInput.value = q;
  if(v) versionSelect.value = v;
}

function setOriginalVisible(isVisible){
  document.body.classList.toggle('orig-hidden', !isVisible);
  btnToggleOrig.setAttribute('aria-expanded', String(isVisible));
  btnToggleOrig.textContent = isVisible ? 'Ocultar original' : 'Mostrar original';
  scheduleSyncVerseHeights();
}

/***********************
 * Events
 ***********************/
form.addEventListener('submit', (e) => { e.preventDefault(); runSearch(); });


  if(themeMenuBtn && themeMenu){
  themeMenuBtn.addEventListener('click', (event) => {
    event.stopPropagation();
    themeMenu.classList.toggle('show');
  });
  document.addEventListener('click', (event) => {
    if(!themeMenu.contains(event.target) && !themeMenuBtn.contains(event.target)){
      themeMenu.classList.remove('show');
    }
  });
}

themeItems.forEach((item) => {
  item.addEventListener('click', () => {
    const theme = item.getAttribute('data-theme');
    applyTheme(theme);
    themeMenu?.classList.remove('show');
  });
});

btnCopyText.addEventListener('click', async () => {
  const left = (passageTextRV.innerText || '').trim();
  const right = (passageTextOrig.innerText || '').trim();
  const includeOrig = !document.body.classList.contains('orig-hidden');
  const combined =
    includeOrig
      ? `=== ${leftLabel.textContent} ===\n${left}\n\n=== ${rightLabel.textContent} ===\n${right}\n`
      : `=== ${leftLabel.textContent} ===\n${left}\n`;
  await copy(combined);
});

btnViewMode?.addEventListener('click', () => {
  const nextMode = viewMode === 'parallel' ? 'interlinear' : 'parallel';
  setViewMode(nextMode);
});

btnToggleOrig.addEventListener('click', () => {
  const isVisible = !document.body.classList.contains('orig-hidden');
  setOriginalVisible(!isVisible);
});
    window.addEventListener('resize', scheduleSyncVerseHeights);
btnPrevPage?.addEventListener('click', () => {
  const slug = btnPrevPage.dataset.book;
  const chapter = Number(btnPrevPage.dataset.chapter);
  if(!slug || !chapter) return;
  navigateToPage(slug, chapter);
});

btnNextPage?.addEventListener('click', () => {
  const slug = btnNextPage.dataset.book;
  const chapter = Number(btnNextPage.dataset.chapter);
  if(!slug || !chapter) return;
  navigateToPage(slug, chapter);
});
    document.querySelector('a[href="analisis.html"]')?.addEventListener('click', () => {
  saveReaderState();
});
/***********************
 * Boot
 ***********************/
(async function boot(){
  setFromUrl();
  setOriginalVisible(ORIGINAL_ENABLED_DEFAULT);
   setViewMode(viewMode);
  applyTheme(localStorage.getItem('lectorTheme') || 'cream');

  leftLabel.textContent = versionSelect.value;
  metaVersion.textContent = versionSelect.value;

  try{
     try{
      const raw = sessionStorage.getItem('lectorState');
      if(raw){
        pendingRestoreState = JSON.parse(raw);
    const safeRefSearch = normalizeSpaces(pendingRestoreState?.lastReferenceSearch || '');
        const fallbackSearch = normalizeSpaces(pendingRestoreState?.lastSearch || '');
        if (safeRefSearch && parseSearch(safeRefSearch) && searchInput) {          searchInput.value = safeRefSearch;
        } else if (fallbackSearch && parseSearch(fallbackSearch) && searchInput) {
          searchInput.value = fallbackSearch;
        }
        if (pendingRestoreState?.currentBookSlug) {
          currentBookSlug = pendingRestoreState.currentBookSlug;
        }
        if (pendingRestoreState?.currentBookName) {
          currentBookName = pendingRestoreState.currentBookName;
        }
        if (typeof pendingRestoreState?.origHidden === 'number') {
          setOriginalVisible(pendingRestoreState.origHidden ? false : true);
        }
      }
    }catch{}
    passageTextRV.innerHTML = `<div class="text-muted">Cargando ${leftLabel.textContent}…</div>`;
    passageTextOrig.innerHTML = `<div class="text-muted">Cargando Original…</div>`;
    await ensureBookLoaded(currentBookSlug, currentBookName);
    await runSearch();

    // ✅ Restaurar scroll/estado si venimos de busqueda.html
// ✅ Restaurar scroll/estado si venimos de busqueda.html
try{
 const st = pendingRestoreState;
  if(st){

    if(typeof st.scrollY === 'number'){
      requestAnimationFrame(() => window.scrollTo(0, st.scrollY));
    }

    sessionStorage.removeItem('lectorState');
  }
}catch{}


  }catch(err){
    const msg = `<div class="text-danger fw-semibold">Error:</div><div class="text-muted">${esc(err.message || String(err))}</div>`;
    passageTextRV.innerHTML = msg;
    passageTextOrig.innerHTML = `<div class="text-muted">—</div>`;
    statusLine.textContent = '';
  }
})();
  </script>

  <div id="ctxMenu" class="ctx-menu" style="display:none" aria-hidden="true"></div>
  <script src="./textos-cruzados.js"></script>
<script src="./comentarios/comentarios.js"></script>
  <script defer src="./rkant-es-ui.js?v=1"></script>



</body>
</html>
