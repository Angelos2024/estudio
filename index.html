<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lector de Pasajes</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --bd:#e6e8eb; --muted:#6b7280; }
    body{ background:#f8fafc; }
    .topbar{
      background:#ffffff;
      border-bottom:1px solid var(--bd);
      position:sticky; top:0; z-index:1000;
    }
    .sitewrap{ max-width: 1200px; }
    .panel{
      background:#fff;
      border:1px solid var(--bd);
      border-radius:12px;
    }
    .panel-header{
      border-bottom:1px solid var(--bd);
      padding:.75rem 1rem;
      font-weight:600;
    }
    .panel-body{ padding:1rem; }
    .meta-row{ color:var(--muted); font-size:.9rem; }
    .passage-title{ font-size:1.25rem; font-weight:700; }
    .passage-text{ font-size:1.05rem; line-height:1.85; }
    .orig-text{ font-size:1.05rem; line-height:1.85; }
    .verse-num{ color:#2563eb; font-weight:700; margin-right:.25rem; font-size:.85em; }
    .btn-soft{ background:#f1f5f9; border:1px solid var(--bd); }
    .btn-soft:hover{ background:#e9eef5; }
    .sticky-aside{ position: sticky; top: 86px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    /* Layout paralelo (español izquierda / original derecha) con colapsado del original */
    .parallel{ display:flex; flex-wrap:wrap; gap:1rem; }
    .parallel-col{ flex:1 1 360px; min-width:320px; }
    .orig-hidden #origCol{ display:none !important; }
    .orig-hidden #spanishCol{ flex:1 1 100%; min-width:100%; }

    /* Columna de herramientas a la izquierda, más compacta */
    .tools-panel .panel-body{ padding:.75rem; }
    .tools-panel .btn{ padding:.4rem .6rem; font-size:.9rem; }
  </style>
</head>

<body>
  <!-- TOP SEARCH BAR -->
  <header class="topbar">
    <div class="container sitewrap py-2">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 gap-lg-3">
        <div class="d-flex align-items-center gap-2 flex-grow-1">
          <span class="badge text-bg-dark rounded-pill">Lector</span>
          <form id="searchForm" class="d-flex gap-2 flex-grow-1">
            <input id="searchInput" class="form-control" value="1 Corintios 13:1-7" placeholder="Buscar: ej. 1 Corintios 13 / 1Co 13:1-7"/>
            <select id="versionSelect" class="form-select" style="max-width:180px">
              <option value="RVR1960" selected>RVR1960</option>
            </select>
            <button class="btn btn-primary" type="submit">Buscar</button>
          </form>
        </div>

        <div class="d-flex gap-2">
          <button id="btnCopyLink" class="btn btn-soft btn-sm" type="button">Compartir</button>
          <button id="btnCopyText" class="btn btn-soft btn-sm" type="button">Copiar</button>
          <button id="btnPrint" class="btn btn-soft btn-sm" type="button">Imprimir</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container sitewrap my-3 my-lg-4">
    <!-- Header: título + versión (sin navegación) -->
    <div class="d-flex flex-column gap-2 mb-3">
      <div class="d-flex flex-column flex-md-row justify-content-between gap-2 align-items-md-start">
        <div>
          <div class="passage-title" id="pageTitle">—</div>
          <div class="meta-row">
            Versión: <span class="fw-semibold" id="metaVersion">—</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- LEFT TOOLS (compact) -->
      <aside class="col-12 col-lg-2">
        <div class="sticky-aside d-flex flex-column gap-3">
          <section class="panel tools-panel">
            <div class="panel-header">Herramientas</div>
            <div class="panel-body d-grid gap-2">
              <button class="btn btn-soft w-100" type="button" disabled>Comparar</button>
              <button class="btn btn-soft w-100" type="button" disabled>Notas</button>
              <button class="btn btn-soft w-100" type="button" disabled>Interlineal</button>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">Ayuda</div>
            <div class="panel-body text-muted" style="font-size:.9rem">
              Ejemplos: <span class="mono">1Cor 3</span>, <span class="mono">1 Cor 13:1-7</span>, <span class="mono">1 Corintios 15:58</span>
            </div>
          </section>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="col-12 col-lg-10">
        <section class="panel">
          <div class="panel-header d-flex justify-content-between align-items-center gap-2">
            <span>Texto del pasaje</span>

            <div class="d-flex align-items-center gap-2">
              <span class="text-muted" style="font-weight:400; font-size:.9rem" id="statusLine"></span>
              <button id="btnToggleOrig" class="btn btn-soft btn-sm" type="button" aria-expanded="true">
                Ocultar original
              </button>
            </div>
          </div>

          <div class="panel-body">
            <div class="parallel">
              <!-- IZQUIERDA: Español -->
              <div id="spanishCol" class="parallel-col">
                <div class="fw-semibold mb-2" id="leftLabel">RVR1960</div>
                <div class="passage-text" id="passageTextRV">
                  <div class="text-muted">Cargando datos…</div>
                </div>
              </div>

              <!-- DERECHA: Original -->
              <div id="origCol" class="parallel-col">
                <div class="fw-semibold mb-2" id="rightLabel">Original</div>
                <div class="orig-text" id="passageTextOrig">
                  <div class="text-muted">Cargando datos…</div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>

  <script>
    /***********************
 * Config (dinámico por libro)
 ***********************/
// Convención asumida:
//  - Español (izquierda):  ./librosRV1960/<slug>.json
//  - Original NT (derecha): ./librosOriginal/<slug>_griego.json
//  - Original AT (derecha): ./librosOriginal/<slug>_hebreo.json
//
// Puedes sobrescribir por URL:
//   ?book=galatas
//   ?book=deuteronomio
//   ?rvBase=./librosRV1960/&origBase=./librosRV1960/   (si tus originales están ahí)
//   ?name=Gálatas   (título visible)

const params = new URLSearchParams(window.location.search);

const RV_BASE = params.get('rvBase') || './librosRV1960/';
const ORIG_BASE = params.get('origBase') || './librosOriginal/';

const BOOK_SLUG = (params.get('book') || '1_corintios').trim();
const BOOK_NAME = (params.get('name') || BOOK_SLUG.replace(/_/g, ' '))
  .replace(/\b\w/g, c => c.toUpperCase());

// Lista de slugs del NT (ajusta si tus nombres difieren)
const NT_BOOKS = new Set([
  'mateo','marcos','lucas','juan','hechos',
  'romanos','1_corintios','2_corintios','galatas','efesios','filipenses','colosenses',
  '1_tesalonicenses','2_tesalonicenses','1_timoteo','2_timoteo','tito','filemon',
  'hebreos','santiago','1_pedro','2_pedro','1_juan','2_juan','3_juan','judas','apocalipsis'
]);

const isNT = NT_BOOKS.has(BOOK_SLUG);

// IZQUIERDA (RVR1960)
const JSON_PATH_RV = `${RV_BASE}${BOOK_SLUG}.json`;

// DERECHA (Original)
const ORIGINAL_LABEL = isNT ? 'Griego' : 'Hebreo';
const JSON_PATH_ORIG = isNT
  ? `${ORIG_BASE}${BOOK_SLUG}_griego.json`
  : `${ORIG_BASE}${BOOK_SLUG}_hebreo.json`;
/***********************
     * DOM
     ***********************/
    const form = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const versionSelect = document.getElementById('versionSelect');
    const metaVersion = document.getElementById('metaVersion');
    const pageTitle = document.getElementById('pageTitle');
    const statusLine = document.getElementById('statusLine');

    const passageTextRV = document.getElementById('passageTextRV');
    const passageTextOrig = document.getElementById('passageTextOrig');

    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');

    const btnCopyLink = document.getElementById('btnCopyLink');
    const btnCopyText = document.getElementById('btnCopyText');
    const btnPrint = document.getElementById('btnPrint');
    const btnToggleOrig = document.getElementById('btnToggleOrig');

    /***********************
     * Data
     ***********************/
    let bookDataRV = null;    // data[chapterIndex][verseIndex] = string
    let bookDataOrig = null;  // misma estructura
    let lastRef = null;       // {chapter, verseStart, verseEnd}

    /***********************
     * Helpers
     ***********************/
    function esc(s){
      return (s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#39;");
    }

    function normalizeSpaces(s){
      return (s || '').trim().replace(/\s+/g,' ');
    }

    // Acepta: "1Cor 13:1-7", "1 Corintios 13", "1 cor 15:58"
    // MVP: solo 1 Corintios (porque el JSON es de ese libro).
    function parseSearch(raw){
      const q = normalizeSpaces(raw).toLowerCase();

      // permite también búsquedas sin nombre del libro (por MVP)
      const m = q.match(/(\d+)(?::(\d+)(?:\s*-\s*(\d+))?)?$/);
      if(!m) return null;

      const chapter = parseInt(m[1], 10);
      const verseStart = m[2] ? parseInt(m[2], 10) : null;
      const verseEnd = m[3] ? parseInt(m[3], 10) : (verseStart ? verseStart : null);

      return { book: BOOK_NAME, chapter, verseStart, verseEnd };
    }

    function clamp(n, min, max){
      return Math.max(min, Math.min(max, n));
    }

    function buildPermalink(search, version){
      const p = new URLSearchParams();
      p.set('search', search);
      p.set('version', version);
      return `${location.origin}${location.pathname}?${p.toString()}`;
    }

    async function copy(text){
      try{ await navigator.clipboard.writeText(text); }catch{}
    }

    function render(ref){
      if(!bookDataRV) return;

      const chapterCount = bookDataRV.length;
      const ch = clamp(ref.chapter, 1, chapterCount);

      const versesRV = bookDataRV[ch-1] || [];
      const verseCount = versesRV.length;

      let v1 = ref.verseStart ?? 1;
      let v2 = ref.verseEnd ?? verseCount;

      v1 = clamp(v1, 1, verseCount);
      v2 = clamp(v2, 1, verseCount);
      if(v2 < v1) [v1, v2] = [v2, v1];

      lastRef = { chapter: ch, verseStart: v1, verseEnd: v2 };

      const range = (ref.verseStart == null)
        ? `${BOOK_NAME} ${ch}`
        : `${BOOK_NAME} ${ch}:${v1}${(v2 !== v1 ? '-' + v2 : '')}`;

      pageTitle.textContent = range;
      metaVersion.textContent = versionSelect.value;

      // Español (RV)
      let htmlRV = '';
      for(let v=v1; v<=v2; v++){
        const t = versesRV[v-1] ?? '';
        htmlRV += `<p class="mb-2"><span class="verse-num">${v}</span>${esc(t)}</p>`;
      }
      passageTextRV.innerHTML = htmlRV || `<div class="text-muted">Sin contenido para esta referencia.</div>`;

      // Original
      if(bookDataOrig){
        const versesOrig = bookDataOrig[ch-1] || [];
        let htmlOrig = '';
        for(let v=v1; v<=v2; v++){
          const t = versesOrig[v-1] ?? '';
          htmlOrig += `<p class="mb-2"><span class="verse-num">${v}</span>${esc(t)}</p>`;
        }
        passageTextOrig.innerHTML = htmlOrig || `<div class="text-muted">Sin contenido original para esta referencia.</div>`;
      }else{
        passageTextOrig.innerHTML = `<div class="text-muted">Original no cargado (revisa JSON_PATH_ORIG).</div>`;
      }

      statusLine.textContent = `Capítulos: ${chapterCount} · Cap ${ch}: ${verseCount} vers.`;

      const userSearch = normalizeSpaces(searchInput.value) || range;
      history.replaceState(null, '', `?search=${encodeURIComponent(userSearch)}&version=${encodeURIComponent(versionSelect.value)}`);
    }

    function runSearch(){
      const raw = normalizeSpaces(searchInput.value);
      if(!raw){
        passageTextRV.innerHTML = `<div class="text-muted">Escribe una referencia.</div>`;
        passageTextOrig.innerHTML = `<div class="text-muted">Escribe una referencia.</div>`;
        return;
      }

      const ref = parseSearch(raw);
      if(!ref){
        const msg = `<div class="text-muted">No se pudo interpretar la búsqueda. Ej: <span class="mono">1Cor 13:1-7</span></div>`;
        passageTextRV.innerHTML = msg;
        passageTextOrig.innerHTML = msg;
        return;
      }

      render(ref);
    }

    /***********************
     * Init
     ***********************/
    async function loadJson(path){
      const r = await fetch(path, { cache: 'no-store' });
      if(!r.ok) throw new Error(`No se pudo cargar ${path} (HTTP ${r.status})`);
      return await r.json();
    }

    function setFromUrl(){
      const p = new URLSearchParams(location.search);
      const q = p.get('search');
      const v = p.get('version');
      if(q) searchInput.value = q;
      if(v) versionSelect.value = v;
    }

    function setOriginalVisible(isVisible){
      document.body.classList.toggle('orig-hidden', !isVisible);
      btnToggleOrig.setAttribute('aria-expanded', String(isVisible));
      btnToggleOrig.textContent = isVisible ? 'Ocultar original' : 'Mostrar original';
    }

    form.addEventListener('submit', (e) => { e.preventDefault(); runSearch(); });

    btnCopyLink.addEventListener('click', async () => {
      const link = buildPermalink(searchInput.value || pageTitle.textContent, versionSelect.value);
      await copy(link);
    });

    btnCopyText.addEventListener('click', async () => {
      const left = (passageTextRV.innerText || '').trim();
      const right = (passageTextOrig.innerText || '').trim();
      const includeOrig = !document.body.classList.contains('orig-hidden');
      const combined =
        includeOrig
          ? `=== ${leftLabel.textContent} ===\n${left}\n\n=== ${rightLabel.textContent} ===\n${right}\n`
          : `=== ${leftLabel.textContent} ===\n${left}\n`;
      await copy(combined);
    });

    btnPrint.addEventListener('click', () => window.print());

    btnToggleOrig.addEventListener('click', () => {
      const isVisible = !document.body.classList.contains('orig-hidden');
      setOriginalVisible(!isVisible);
    });

    (async function boot(){
      setFromUrl();

      leftLabel.textContent = versionSelect.value;
      rightLabel.textContent = ORIGINAL_LABEL;

      // visible por defecto
      setOriginalVisible(true);

      try{
        passageTextRV.innerHTML = `<div class="text-muted">Cargando ${leftLabel.textContent}…</div>`;
        bookDataRV = await loadJson(JSON_PATH_RV);

        try{
          passageTextOrig.innerHTML = `<div class="text-muted">Cargando ${ORIGINAL_LABEL}…</div>`;
          bookDataOrig = await loadJson(JSON_PATH_ORIG);
        }catch(e){
          bookDataOrig = null;
          passageTextOrig.innerHTML = `<div class="text-muted">Original no cargado. Revisa <span class="mono">JSON_PATH_ORIG</span>.</div>`;
        }

        runSearch();
      }catch(err){
        const msg = `<div class="text-danger fw-semibold">Error:</div><div class="text-muted">${esc(err.message || String(err))}</div>`;
        passageTextRV.innerHTML = msg;
        passageTextOrig.innerHTML = msg;
        statusLine.textContent = '';
      }
    })();
  </script>
</body>
</html>
